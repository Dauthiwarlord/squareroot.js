/*

Squareroot.js
A micro 3d engine for Canvas and CSS

Version 1.1
Build 56 | Fri Aug  2 10:32:26 2013

Contains requestAnimFrame.js by Paul Irish
http://paulirish.com/2011/requestanimationframe-for-smart-animating/

*/
window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)}}();var SQR=function(){if(typeof window.Float32Array=="undefined")window.Float32Array=window.Array;return{DYNAMIC_TRANSFORM:0,STATIC_TRANSFORM:1,twoPI:Math.PI*2,deg2rad:Math.PI/180,rad2deg:180/Math.PI,supportsCss3d:!1,usePreserve3d:!1}}();SQR.BUILD=56;SQR.Squareroot=function(a,b){var c={};c.projection=new SQR.ProjectionMatrix;this.lightDirection=(new SQR.V3(0,1,0)).norm();this.setBackground=function(b){if(a)a.style.backgroundColor=b};this.setClearColor=function(a){f=a};this.setProjection=function(a){c.cssDistance=0.5/Math.tan(a*Math.PI/360)*c.height;c.projection.perspective(a,c.width/c.height,0.1,1E3);if(b)b.style.perspective=c.cssDistance+"px",b.style["-webkit-perspective"]=c.cssDistance+"px",b.style["-moz-perspective"]=c.cssDistance+"px",b.style["-o-perspective"]=
c.cssDistance+"px"};this.cssDistance=function(){return c.cssDistance};this.setSize=function(b,d){c.width=b;c.height=d;if(a)a.width=b,a.height=d;c.aspect=b/d;c.centerX=b*0.5;c.centerY=d*0.5};this.children=[];this.numChildren=0;var d=[];this.add=function(){for(var a=0;a<arguments.length;a++){var b=arguments[a];b.parent=null;this.children.indexOf(b)==-1&&this.children.push(b)}this.numChildren=this.children.length};this.remove=function(){for(var a=0;a<arguments.length;a++){var b=arguments[a],c=this.children.indexOf(b);
if(c==-1)return!1;b.parent=null;b.renderer&&(b.renderer.isDom2d||b.renderer.isDom3d)&&b.renderer.removeFromDom();this.children.splice(c,1)}this.numChildren=this.children.length};this.contains=function(a){return this.children.indexOf(a)>-1};this.recurse=function(a){for(var b=0;b<this.numChildren;b++)this.children[b].recurse(a)};this.removeAll=function(){for(var a=0;a<this.numChildren;a++){var b=this.children[a];b.parent=null;b.renderer&&(b.renderer.isDom2d||b.renderer.isDom3d)&&b.renderer.removeFromDom()}this.children=
[];this.numChildren=this.children.length};var e=function(a){a.renderer&&(a.renderer.isDom3d&&SQR.usePreserve3d&&a.parent&&a.parent.renderer&&a.parent.renderer.isDom3d?a.renderer.appendToDom(a.parent.renderer.element):(a.renderer.isDom2d||a.renderer.isDom3d)&&a.renderer.appendToDom(b));a.transformWorld();d.push(a);if(a.numChildren>0)for(var c=0;c<a.numChildren;c++)e(a.children[c])};this.render=function(b){SQR.Time.tick();d.length=0;if(c.context)c.context.setTransform(1,0,0,1,0,0),f!=null?(c.context.fillStyle=
f,c.context.fillRect(0,0,a.width,a.height)):c.context.clearRect(0,0,a.width,a.height);for(var h=0;h<this.numChildren;h++)e(this.children[h]);var i=d.length;c.camera=b;c.viewMatrix=b.computeInverseMatrix();c.lightDirection=this.lightDirection;for(h=0;h<i;h++)b=d[h],b.transformView(c.viewMatrix);d.sort(function(a,b){var c=a.depth(),d=b.depth();if(c<d)return-1;if(c>d)return 1;return 0});for(h=0;h<i;h++)if(b=d[h],b.enabled){if(b.renderer)c.depth=h,b.renderer.draw(b,c);b.collider&&b.collider.project(b,
c)}};if(a)c.context=a.getContext("2d"),this.setSize(a.width,a.height);c.projection.identity();c.container=b;this.lightDirection.set(0,1,0).norm();var f=null};SQR.Transform=function(a){this.name=a;this.enabled=!0;this.useQuaternion=this.directMatrixMode=!1;this.engine=this.parent=this.collider=this.geometry=this.renderer=null;this.position=new SQR.V3;this.rotation=new SQR.V3;this.rotationQ=new SQR.Quaternion;this.scale=new SQR.V3(1,1,1);var b=new SQR.V3;this.matrix=new SQR.Matrix44;this.globalMatrix=new SQR.Matrix44;this.viewMatrix=new SQR.Matrix44;this.inverseWorldMatrix=new SQR.Matrix44;this.positioningMode=0;this.depth=function(){return this.viewMatrix.data[14]};
this.children=[];this.numChildren=0;this.add=function(){for(var a=0;a<arguments.length;a++){var b=arguments[a];b.parent=this;this.children.indexOf(b)==-1&&this.children.push(b)}this.numChildren=this.children.length};this.remove=function(){for(var a=0;a<arguments.length;a++){var b=arguments[a],e=this.children.indexOf(b);if(e==-1)return!1;b.parent=null;b.renderer&&(b.renderer.isDom2d||b.renderer.isDom3d)&&b.renderer.removeFromDom();this.children.splice(e,1)}this.numChildren=this.children.length};this.contains=
function(a){return this.children.indexOf(a)>-1};this.recurse=function(a){a(this);for(var b=0;b<this.numChildren;b++)this.children[b].recurse(a)};this.removeAll=function(){for(var a=0;a<this.numChildren;a++){var b=this.children[a];b.parent=null;b.renderer&&(b.renderer.isDom2d||b.renderer.isDom3d)&&b.renderer.removeFromDom()}this.children=[];this.numChildren=this.children.length};this.transformWorld=function(){if(this.positioningMode!=2){if(!this.directMatrixMode){var a=this.position,b=this.rotationQ,
e=this.rotation,f=this.scale;this.useQuaternion?this.matrix.setTQS(a.x,a.y,a.z,b.w,b.x,b.y,b.z,f.x,f.y,f.z):this.matrix.setTRS(a.x,a.y,a.z,e.x,e.y,e.z,f.x,f.y,f.z)}this.lookDirection&&this.matrix.lookAt(this.lookDirection,SQR.V3.up);this.parent?(this.parent.globalMatrix.copyTo(this.globalMatrix),this.globalMatrix.multiply(this.matrix)):this.matrix.copyTo(this.globalMatrix);this.lookTarget&&this.globalMatrix.lookAt(this.lookTarget.globalPosition(),SQR.V3.up);if(this.positioningMode==1)this.positioningMode=
2}};this.globalPosition=function(){this.globalMatrix.extractPosition(b);return b};this.transformView=function(a){a.copyTo(this.viewMatrix);this.viewMatrix.multiply(this.globalMatrix)};this.lookAt=function(a){this.lookTarget=a};this.lookInDirection=function(a){this.lookDirection=a};this.computeInverseMatrix=function(){this.globalMatrix.inverse(this.inverseWorldMatrix);return this.inverseWorldMatrix}};SQR.Geometry=function(){this.tangents=this.normals=this.particleTextures=this.colors=this.polygons=this.vertices=null;this.closed=this.continous=!1;this.color=null};SQR.Geometry.prototype.addTriangle=function(a,b,c,d){if(!this.polygons)this.polygons=[];this.polygons.push(new SQR.Triangle(a,b,c,d))};SQR.Geometry.prototype.addQuad=function(a,b,c,d,e){if(!this.polygons)this.polygons=[];this.polygons.push(new SQR.Quad(a,b,c,d,e))};
SQR.Geometry.prototype.addSegment=function(a,b,c){if(!this.vertices)this.vertices=[];this.vertices.push(a,b);if(c){if(!this.colors)this.colors=[];this.colors.push(c)}};SQR.Plane=function(a,b,c,d,e,f,g){this.polygons=[];c=c||1;d=d||1;a*=0.5;b*=0.5;e=-a+(e||0);f=-b+(f||0);var h=a*2/c,i=b*2/d,j,m;for(j=0;j<c;j++)for(m=0;m<d;m++){var n=e+j*h,l=n+h,k=f+m*i,o=k+i,p;g?(p=new SQR.V3(n,0,k),k=new SQR.V3(l,0,k),l=new SQR.V3(l,0,o),n=new SQR.V3(n,0,o)):(p=new SQR.V3(n,k,0),k=new SQR.V3(l,k,0),l=new SQR.V3(l,o,0),n=new SQR.V3(n,o,0));o=new SQR.Color(0,100,70);this.polygons.push(new SQR.Triangle(p,k,l,o));this.polygons.push(new SQR.Triangle(p,l,n,o))}this.applyHeightMap=function(c,
d,e,f){for(var g=this.polygons.length,h=function(g){var h=(g.z/b+1)/2,i=(g.x/a+1)/2;h=(e+h*f)%1;h=SQR.CanvasUtil.getPixelNormRed(c,i,h)/255*d;g.y=d-h},i=0;i<g;i++){var n=this.polygons[i];h(n.a);h(n.b);h(n.c)}}};SQR.Quad=function(a,b,c,d,e){var f=this;this.a=a;this.b=b;this.c=c;this.d=d;this.color=e;this.sa=new SQR.V3;this.sb=new SQR.V3;this.sc=new SQR.V3;this.sd=new SQR.V3;this.normal=new SQR.V3;this.center=new SQR.V3;this.depth=0;this.update=function(a,b,c){this.a.copyTo(this.sa);this.b.copyTo(this.sb);this.c.copyTo(this.sc);this.d.copyTo(this.sd);a.transformVector(this.sa);a.transformVector(this.sb);a.transformVector(this.sc);a.transformVector(this.sd);this.center.set(0,0,0).add(this.sa,this.sb).add(this.center,
this.sc).mul(1/3);this.depth=this.center.z;this.sa.x=this.sa.x/this.sa.z*b+b;this.sa.y=this.sa.y/this.sa.z*c+c;this.sb.x=this.sb.x/this.sb.z*b+b;this.sb.y=this.sb.y/this.sb.z*c+c;this.sc.x=this.sc.x/this.sc.z*b+b;this.sc.y=this.sc.y/this.sc.z*c+c;this.sd.x=this.sd.x/this.sd.z*b+b;this.sd.y=this.sd.y/this.sd.z*c+c;a=SQR.VectorUtil.__tv1;b=SQR.VectorUtil.__tv2;c=SQR.VectorUtil.__tv3;a.sub(f.sa,f.sb);b.sub(f.sc,f.sb);c.sub(f.sc,f.sd);a.cross(a,b);c.cross(b,c);f.normal.add(a,c).norm()}};SQR.Triangle=function(a,b,c,d){var e=this;this.a=a;this.b=b;this.c=c;this.color=d;this.sa=new SQR.V3;this.sb=new SQR.V3;this.sc=new SQR.V3;this.normal=new SQR.V3;this.center=new SQR.V3;this.depth=0;this.update=function(a,b,c){this.a.copyTo(this.sa);this.b.copyTo(this.sb);this.c.copyTo(this.sc);a.transformVector(this.sa);a.transformVector(this.sb);a.transformVector(this.sc);this.center.set(0,0,0).add(this.sa,this.sb).add(this.center,this.sc).mul(1/3);this.depth=this.center.z;this.sa.x=this.sa.x/this.sa.z*
b+b;this.sa.y=this.sa.y/this.sa.z*c+c;this.sb.x=this.sb.x/this.sb.z*b+b;this.sb.y=this.sb.y/this.sb.z*c+c;this.sc.x=this.sc.x/this.sc.z*b+b;this.sc.y=this.sc.y/this.sc.z*c+c;a=SQR.VectorUtil.__tv1;b=SQR.VectorUtil.__tv2;a.sub(e.sa,e.sb);b.sub(e.sa,e.sc);e.normal.cross(a,b).norm()}};SQR.Interpolation={bezierPosition:function(a,b,c,d,e){return b*(1-a)*(1-a)*(1-a)+c*3*a*(1-a)*(1-a)+d*3*a*a*(1-a)+e*a*a*a},bezierVelocity:function(a,b,c,d,e){return 3*c-3*b+2*(3*b-6*c+3*d)*a+3*(-b+3*c-3*d+e)*a*a},smoothStep:function(a,b,c){if(c<=a)return a;if(c>=b)return b;c=(c-a)/(b-a);return a+(3*c*c-2*c*c*c)*(b-a)},quadIn:function(a){return a*a},quadOut:function(a){return a*(2-a)},quadInOut:function(a){return(a*=2)<1?0.5*a*a:-0.5*(--a*(a-2)-1)}};SQR.Mathx={clamp:function(a,b,c){if(a<b)return b;return a>c?c:a},clamp01:function(a){if(a<0)return 0;return a>1?1:a},step:function(a,b){return b>=a?1:0}};SQR.Matrix2D=function(){typeof Float32Array=="undefined"&&(Float32Array=Array);this.data=new Float32Array(9);var a,b,c,d,e;this.identity=function(){c=this.data;c[0]=1;c[1]=0;c[2]=0;c[3]=0;c[4]=1;c[5]=0;c[6]=0;c[7]=0;c[8]=1;return this};this.transformVector=function(a){c=this.data;d=a.x;e=a.y;a.x=c[0]*d+c[1]*e+c[2];a.y=c[3]*d+c[4]*e+c[5];return a};this.setTranslation=function(a,b,d){c=d||this.data;c[0]=1;c[1]=0;c[2]=a;c[3]=0;c[4]=1;c[5]=b;c[6]=0;c[7]=0;c[8]=1;return this};this.getTranslation=function(a){c=
this.data;a=a||new SQR.V2;a.x=c[2];a.y=c[5];return a};this.setScale=function(a,b,d){c=d||this.data;c[0]=a;c[1]=0;c[2]=0;c[3]=0;c[4]=b;c[5]=0;c[6]=0;c[7]=0;c[8]=1;return this};this.setShear=function(a,b,d){c=d||this.data;c[0]=1;c[1]=a;c[2]=0;c[3]=b;c[4]=1;c[5]=0;c[6]=0;c[7]=0;c[8]=1;return this};this.setRotation=function(a,b){c=b||this.data;var d=Math.cos(a),e=Math.sin(a);c[0]=d;c[1]=-e;c[2]=0;c[3]=e;c[4]=d;c[5]=0;c[6]=0;c[7]=0;c[8]=1;return this};this.setTRS=function(a,b,d,e,f){c=this.data;var g=
Math.cos(d);d=Math.sin(d);c[0]=g*e;c[1]=-d*f;c[2]=a;c[3]=d*e;c[4]=g*f;c[5]=b;c[6]=0;c[7]=0;c[8]=1;return this};this.translate=function(a,b){this.setTranslation(a,b,SQR.Matrix2D.__temp);return this.multiply(SQR.Matrix2D.__temp)};this.rotate=function(a){this.setRotation(a,SQR.Matrix2D.__temp);return this.multiply(SQR.Matrix2D.__temp)};this.scale=function(a,b){this.setScale(a,b,SQR.Matrix2D.__temp);return this.multiply(SQR.Matrix2D.__temp)};this.shear=function(a,b){this.setRotation(a,b,SQR.Matrix2D.__temp);
return this.multiply(SQR.Matrix2D.__temp)};var f,g,h,i,j,m,n,l,k,o,p,q,r,t,v;this.multiply=function(c){a=this.data;b=c.data||c;f=a[0];g=a[1];h=a[2];i=a[3];j=a[4];m=a[5];n=b[0];l=b[1];k=b[2];o=b[3];p=b[4];q=b[5];r=b[6];t=b[7];v=b[8];a[0]=f*n+g*o+h*r;a[1]=f*l+g*p+h*t;a[2]=f*k+g*q+h*v;a[3]=i*n+j*o+m*r;a[4]=i*l+j*p+m*t;a[5]=i*k+j*q+m*v;return this};this.copyTo=function(c){a=this.data;b=c.data||c;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];return c};this.copyFrom=
function(c){a=c.data||c;b=this.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];return this};var u=function(a){return Math.abs(a)<1.0E-6?0:a};this.getAsCSSProperty=function(a){var b=this.data;return a?"matrix3d("+u(b[0])+","+u(b[3])+",0,0,"+u(b[1])+","+u(b[4])+",0,0,0,0,1,0,"+u(b[2])+","+u(b[5])+",0,1)":"matrix("+u(b[0])+","+u(b[3])+","+u(b[1])+","+u(b[4])+","+u(b[2])+","+u(b[5])+")"};this.identity()};SQR.Matrix33=function(){this.data=new Float32Array(9);this.identity=function(){var a=this.data;a[0]=1;a[3]=0;a[6]=0;a[1]=0;a[4]=1;a[7]=0;a[2]=0;a[5]=0;a[8]=1;return this};this.transformVector=function(a,b){var c=this.data,d=a.x,e=a.y,f=a.z;b=b||a;b.x=c[0]*d+c[3]*e+c[6]*f;b.y=c[1]*d+c[4]*e+c[7]*f;b.z=c[2]*d+c[5]*e+c[8]*f;return b};this.determinant=function(){var a=this.data;return a[0]*(a[4]*a[8]-a[7]*a[5])+a[3]*(a[7]*a[2]-a[1]*a[8])+a[6]*(a[1]*a[5]-a[4]*a[2])};this.inverse=function(a){var b=this.data;
a=a||this.data;var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],m=b[8],n=m*g-h*j,l=-m*f+h*i,k=j*f-g*i;b=c*n+d*l+e*k;if(!b)return console.warn("Attempt to inverse a singular matrix44. ",this.data),a;b=1/b;a[0]=n*b;a[1]=(-m*d+e*j)*b;a[2]=(h*d-e*g)*b;a[3]=l*b;a[4]=(m*c-e*i)*b;a[5]=(-h*c+e*f)*b;a[6]=k*b;a[7]=(-j*c+d*i)*b;a[8]=(g*c-d*f)*b;return a};this.transpose=function(){var a=this.data,b=a[3],c=a[6],d=a[1],e=a[4],f=a[7],g=a[2],h=a[5],i=a[8];a[0]=a[0];a[1]=b;a[2]=c;a[3]=d;a[4]=e;a[5]=f;a[6]=
g;a[7]=h;a[8]=i}};SQR.Matrix44=function(){this.data=new Float32Array(16);this.identity=function(a){a=a||this.data;a[0]=1;a[4]=0;a[8]=0;a[12]=0;a[1]=0;a[5]=1;a[9]=0;a[13]=0;a[2]=0;a[6]=0;a[10]=1;a[14]=0;a[3]=0;a[7]=0;a[11]=0;a[15]=1};this.transformVector=function(a,c){var d=this.data,e=a.x,f=a.y,g=a.z,h=a.w;c=c||a;c.x=d[0]*e+d[4]*f+d[8]*g+d[12]*h;c.y=d[1]*e+d[5]*f+d[9]*g+d[13]*h;c.z=d[2]*e+d[6]*f+d[10]*g+d[14]*h;return c};this.multiply=function(a){var c=this.data,d=a.data||a,e,f,g,h,i,j,m,n,l,k,o,p,q,r,t,v,u,z,A,B,
w,x,y,C,D,s,E,F,G,H;a=c[0];e=c[1];f=c[2];g=c[3];h=c[4];i=c[5];j=c[6];m=c[7];n=c[8];l=c[9];k=c[10];o=c[11];p=c[12];q=c[13];r=c[14];t=c[15];v=d[0];u=d[1];z=d[2];A=d[3];B=d[4];w=d[5];x=d[6];y=d[7];C=d[8];D=d[9];s=d[10];E=d[11];F=d[12];G=d[13];H=d[14];d=d[15];c[0]=a*v+h*u+n*z+p*A;c[1]=e*v+i*u+l*z+q*A;c[2]=f*v+j*u+k*z+r*A;c[3]=g*v+m*u+o*z+t*A;c[4]=a*B+h*w+n*x+p*y;c[5]=e*B+i*w+l*x+q*y;c[6]=f*B+j*w+k*x+r*y;c[7]=g*B+m*w+o*x+t*y;c[8]=a*C+h*D+n*s+p*E;c[9]=e*C+i*D+l*s+q*E;c[10]=f*C+j*D+k*s+r*E;c[11]=g*C+m*D+
o*s+t*E;c[12]=a*F+h*G+n*H+p*d;c[13]=e*F+i*G+l*H+q*d;c[14]=f*F+j*G+k*H+r*d;c[15]=g*F+m*G+o*H+t*d;return this};this.setTQS=function(a,c,d,e,f,g,h,i,j,m,n){var l=n||this.data;this.identity(n);var k=f*f,o=g*g,p=h*h;l[0]=(1-2*o-2*p)*i;l[1]=(2*f*g-2*h*e)*i;l[2]=(2*f*h+2*g*e)*i;l[4]=(2*f*g+2*h*e)*j;l[5]=(1-2*k-2*p)*j;l[6]=(2*g*h-2*f*e)*j;l[8]=(2*f*h-2*g*e)*m;l[9]=(2*g*h+2*f*e)*m;l[10]=(1-2*k-2*o)*m;l[12]=a;l[13]=c;l[14]=d;return n||this};this.setTRS=function(a,c,d,e,f,g,h,i,j,m){var n=m||this.data;this.identity(m);
var l=Math.sin(e);e=Math.cos(e);var k=Math.sin(f);f=Math.cos(f);var o=Math.sin(g);g=Math.cos(g);n[0]=(f*g+k*l*o)*h;n[1]=(-f*o+k*l*g)*h;n[2]=k*e*h;n[4]=o*e*i;n[5]=g*e*i;n[6]=-l*i;n[8]=(-k*g+f*l*o)*j;n[9]=(o*k+f*l*g)*j;n[10]=f*e*j;n[12]=a;n[13]=c;n[14]=d;return m||this};this.setScale=function(a,c,d,e){var f=e||this.data;this.identity(e);f[0]=a;f[5]=c;f[10]=d;return e||this};this.setTranslation=function(a,c,d,e){var f=e||this.data;this.identity(e);f[12]=a;f[13]=c;f[14]=d;return e||this};this.setRotation=
function(a,c,d,e){var f=e||this.data;this.identity(e);var g=Math.sin(a);a=Math.cos(a);var h=Math.sin(c);c=Math.cos(c);var i=Math.sin(d);d=Math.cos(d);f[0]=c*d+h*g*i;f[1]=-c*i+h*g*d;f[2]=h*a;f[4]=i*a;f[5]=d*a;f[6]=-g;f[8]=-h*d+c*g*i;f[9]=i*h+c*g*d;f[10]=c*a;return e||this};this.translate=function(a,c,d){this.setTranslation(a,c,d,SQR.Matrix44.__temp);return this.multiply(SQR.Matrix44.__temp)};this.rotate=function(a,c,d){this.setRotation(a,c,d,SQR.Matrix44.__temp);return this.multiply(SQR.Matrix44.__temp)};
this.scale=function(a,c,d){this.setScale(a,c,d,SQR.Matrix44.__temp);return this.multiply(SQR.Matrix44.__temp)};this.copyTo=function(a){for(var c=this.data,d=a.data||a,e=0;e<16;e++)d[e]=c[e];return a};this.copyRotationTo=function(a){var c=this.data,d=a.data||a;d[0]=c[0];d[1]=c[1];d[2]=c[2];d[3]=c[4];d[4]=c[5];d[5]=c[6];d[6]=c[8];d[7]=c[9];d[8]=c[10];return a};var a=function(a){return Math.abs(a)<1.0E-6?0:a};this.getAsCSSProperty=function(){var b=this.data;return"matrix3d("+a(b[0])+","+a(b[1])+","+
a(b[2])+","+a(b[3])+","+a(b[4])+","+a(b[5])+","+a(b[6])+","+a(b[7])+","+a(b[8])+","+a(b[9])+","+a(b[10])+","+a(b[11])+","+a(b[12])+","+a(b[13])+","+a(b[14])+","+a(b[15])+")"};this.extractPosition=function(a){var c=this.data;a.set(c[12],c[13],c[14]);return a};this.determinant=function(){var a=this.data;return a[0]*(a[5]*a[10]-a[9]*a[6])+a[4]*(a[9]*a[2]-a[1]*a[10])+a[8]*(a[1]*a[6]-a[5]*a[2])};this.inverse=function(a){var c=this.data,d=a?a.data||a:this.data,e=this.determinant();if(Math.abs(e)<1.0E-4)return console.warn("Attempt to inverse a singular matrix44. ",
this.data),console.trace(),a;var f=c[0],g=c[4],h=c[8],i=c[12],j=c[1],m=c[5],n=c[9],l=c[13],k=c[2],o=c[6],p=c[10];c=c[14];e=1/e;d[0]=(m*p-n*o)*e;d[1]=(h*o-g*p)*e;d[2]=(g*n-h*m)*e;d[4]=(n*k-j*p)*e;d[5]=(f*p-h*k)*e;d[6]=(h*j-f*n)*e;d[8]=(j*o-m*k)*e;d[9]=(g*k-f*o)*e;d[10]=(f*m-g*j)*e;d[12]=-(i*d[0]+l*d[4]+c*d[8]);d[13]=-(i*d[1]+l*d[5]+c*d[9]);d[14]=-(i*d[2]+l*d[6]+c*d[10]);return a};this.transpose=function(a){var c=this.data;a=a?a.data||a:this.data;var d=c[4],e=c[8],f=c[1],g=c[5],h=c[9],i=c[2],j=c[6],
m=c[10];a[0]=c[0];a[1]=d;a[2]=e;a[4]=f;a[5]=g;a[6]=h;a[8]=i;a[9]=j;a[10]=m};this.lookAt=function(a,c){var d=this.data,e=SQR.Matrix44.__tv1,f=SQR.Matrix44.__tv2,g=SQR.Matrix44.__tv3;g.set(d[12],d[13],d[14]);g.sub(g,a).norm();if(g.magsq()===0)g.z=1;e.cross(c,g).norm();e.magsq()===0&&(g.x+=1.0E-4,e.cross(c,g).norm());f.cross(g,e);d[0]=e.x;d[4]=f.x;d[8]=g.x;d[1]=e.y;d[5]=f.y;d[9]=g.y;d[2]=e.z;d[6]=f.z;d[10]=g.z;return this};this.identity()};SQR.Noise={random3_seed:1};SQR.Noise.isPrime=function(a){for(var b=2;b<=a-1;b++)if(a%b==0)return!1;return!0};SQR.Noise.random1=function(a){a^=a<<13;return 1-(a*(a*a*15731+789221)+1376312589&2147483647)/1073741824};SQR.Noise.random2=function(a){a^=a<<13;return(a*16807+16807)%255};SQR.Noise.random3=function(){SQR.Noise.random3_seed=SQR.Noise.random3_seed*16807%2147483647;return SQR.Noise.random3_seed/2147483647};var ImprovedNoise=function(){function a(a){return a*a*a*(a*(a*6-15)+10)}function b(a,b,c){return b+a*(c-b)}function c(a,b,c,d){a&=15;var e=a<8?b:c;b=a<4?c:a==12||a==14?b:d;return((a&1)==0?e:-e)+((a&2)==0?b:-b)}for(var d=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,
211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,
181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],e=0;e<256;e++)d[256+e]=d[e];return{noise:function(e,g,h){var i=~~e,j=~~g,m=~~h,n=i&255,l=j&255,k=m&255;e-=i;g-=j;h-=m;i=e-1;j=g-1;m=h-1;var o=a(e),p=a(g),q=a(h),r=d[n]+l,t=d[r]+k;r=d[r+1]+k;l=d[n+1]+l;n=d[l]+k;k=d[l+1]+k;return b(q,b(p,b(o,c(d[t],e,g,h),c(d[n],i,g,h)),b(o,c(d[r],e,j,h),c(d[k],i,j,h))),b(p,b(o,c(d[t+1],e,g,m),c(d[n+1],i,g,h-1)),b(o,c(d[r+1],e,j,m),c(d[k+
1],i,j,m))))}}};SQR.ProjectionMatrix=function(){typeof Float32Array=="undefined"&&(Float32Array=Array);this.data=new Float32Array(16);this.copyTo=function(a){for(var b=this.data,c=a.data||a,d=0;d<16;d++)c[d]=b[d];return a};this.identity()};SQR.ProjectionMatrix.prototype.identity=function(){var a=this.data;a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1};
SQR.ProjectionMatrix.prototype.perspective=function(a,b,c,d){var e=this.data;a=c*Math.tan(a*Math.PI/360);var f=d-c;e[0]=c/(a*b);e[4]=0;e[8]=0;e[12]=0;e[1]=0;e[5]=c/a;e[9]=0;e[13]=0;e[2]=0;e[6]=0;e[10]=-(d+c)/f;e[14]=-(2*d*c)/f;e[3]=0;e[7]=0;e[11]=-1;e[15]=0};SQR.ProjectionMatrix.prototype.transformVector=function(a,b){var c=a.x,d=a.y,e=a.z,f=a.w,g=this.data;b=b||a;b.x=g[0]*c+g[4]*d+g[8]*e+g[12]*f;b.y=g[1]*c+g[5]*d+g[9]*e+g[13]*f;b.z=g[2]*c+g[6]*d+g[10]*e+g[14]*f;return b};
SQR.ProjectionMatrix.prototype.inverse=function(a){var b=this.data;a=a||this.data;var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],m=b[8],n=b[9],l=b[10],k=b[11],o=b[12],p=b[13],q=b[14];b=b[15];var r=c*h-d*g,t=c*i-e*g,v=c*j-f*g,u=d*i-e*h,z=d*j-f*h,A=e*j-f*i,B=m*p-n*o,w=m*q-l*o,x=m*b-k*o,y=n*q-l*p,C=n*b-k*p,D=l*b-k*q,s=r*D-t*C+v*y+u*x-z*w+A*B;if(!s)return null;s=1/s;a[0]=(h*D-i*C+j*y)*s;a[1]=(-d*D+e*C-f*y)*s;a[2]=(p*A-q*z+b*u)*s;a[3]=(-n*A+l*z-k*u)*s;a[4]=(-g*D+i*x-j*w)*s;a[5]=(c*D-e*x+f*
w)*s;a[6]=(-o*A+q*v-b*t)*s;a[7]=(m*A-l*v+k*t)*s;a[8]=(g*C-h*x+j*B)*s;a[9]=(-c*C+d*x-f*B)*s;a[10]=(o*z-p*v+b*r)*s;a[11]=(-m*z+n*v-k*r)*s;a[12]=(-g*y+h*w-i*B)*s;a[13]=(c*y-d*w+e*B)*s;a[14]=(-o*u+p*t-q*r)*s;a[15]=(m*u-n*t+l*r)*s;return a};SQR.QuadraticBezier=function(a,b,c,d){if(!a||!b&&!c||!d)throw"Failed to create cruve: 4 2D|3D vectors are required.";this.p0=a;this.c0=b;this.c1=c;this.p1=d;var e=a.clone().set(),f=SQR.Interpolation.bezierPosition,g=SQR.Interpolation.bezierVelocity;this.velocityAt=function(a,b){b=b||e;b.x=g(a,this.p0.x,this.c0.x,this.c1.x,this.p1.x);b.y=g(a,this.p0.y,this.c0.y,this.c1.y,this.p1.y);if(b.z&&this.p0.z)b.z=g(a,this.p0.z,this.c0.z,this.c1.z,this.p1.z);return b};this.valueAt=function(a,b){b=b||e;b.x=f(a,
this.p0.x,this.c0.x,this.c1.x,this.p1.x);b.y=f(a,this.p0.y,this.c0.y,this.c1.y,this.p1.y);if(b.z!=null&&this.p0.z!=null)b.z=f(a,this.p0.z,this.c0.z,this.c1.z,this.p1.z);return b};this.createSegment=function(a,b){var c=b||new SQR.Geometry;c.continous=!0;c.vertices=c.vertices||[];c.tangents=c.tangents||[];for(var d=0;d<=a;d++){var e=d/a;c.vertices.push(this.valueAt(e,new SQR.V3));c.tangents.push(this.velocityAt(e,new SQR.V3))}return c};this.createRibbon=function(a,b,c,d){d=d||new SQR.Geometry;for(var e=
0;e<a;e++){var f=e/a,g=(e+1)/a,o=this.valueAt(f,new SQR.V3),p=this.valueAt(g,new SQR.V3);f=this.velocityAt(f,new SQR.V3).norm();var q=this.velocityAt(g,new SQR.V3).norm(),r=new SQR.V3;r.cross(f,q).norm();g=new SQR.V3;g.cross(f,r);f=new SQR.V3;f.cross(q,r);g.mul(b*0.5);f.mul(b*0.5);q=new SQR.V3;r=new SQR.V3;var t=new SQR.V3,v=new SQR.V3;q.add(o,g);r.add(o,g.neg());t.add(p,f);v.add(p,f.neg());d.color=c;d.addTriangle(q,t,r,c);d.addTriangle(t,r,v,c);d.addTriangle(q,r,t,c);d.addTriangle(t,v,r,c)}return d}};SQR.Quaternion=function(a,b,c,d){this.set(a,b,c,d)};SQR.Quaternion.prototype.set=function(a,b,c,d){this.w=a||1;this.x=b||0;this.y=c||0;this.z=d||0};SQR.Quaternion.prototype.copyFrom=function(a){this.w=a.w;this.x=a.x;this.y=a.y;this.z=a.z};SQR.Quaternion.prototype.identity=function(){this.set()};SQR.Quaternion.prototype.mul=function(a,b){b=b||this;b.set(b.w*a.w-b.x*a.x-b.y*a.y-b.z*a.z,b.w*a.x+b.x*a.w+b.y*a.z-b.z*a.y,b.w*a.y-b.x*a.z+b.y*a.w+b.z*a.x,b.w*a.z+b.x*a.y-b.y*a.x+b.z*a.w);b.normalize();return b};
SQR.Quaternion.prototype.lookAt=function(a,b){var c=SQR.Quaternion.__tv1,d=SQR.Quaternion.__tv2,e=SQR.Quaternion.__tv3;a.copyTo(c);b.copyTo(e);c.norm();if(c.z==-1)c.x=1.0E-4,c.norm();d.cross(e,c);e.cross(c,d);this.w=Math.sqrt(1+d.x+e.y+c.z)*0.5;var f=4*this.w;this.x=(c.y-e.z)/f;this.y=(d.z-c.x)/f;this.z=(e.x-d.y)/f;this.normalize();return this};SQR.Quaternion.prototype.fromAngleAxis=function(a,b,c,d){var e=Math.sin(a/2);this.x=b*e;this.y=c*e;this.z=d*e;this.w=Math.cos(a/2)};
SQR.Quaternion.prototype.mag=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)};SQR.Quaternion.prototype.normalize=function(){var a=this.mag();this.x/=a;this.y/=a;this.z/=a;this.w/=a};SQR.Quaternion.prototype.toMatrix=function(){};
SQR.Quaternion.slerp=function(a,b,c,d){d=d||new SQR.Quaternion;var e=a.w*b.w+a.x*b.x+a.y*b.y+a.z*b.z,f=Math.acos(e),g=Math.sqrt(1-e*e),h=Math.sin((1-c)*f)/g;c=Math.sin(c*f)/g;Math.abs(e)>=1?(h=1,c=0):Math.abs(g)<0.0010&&(c=h=0.5);d.w=a.w*h+b.w*c;d.x=a.x*h+b.x*c;d.y=a.y*h+b.y*c;d.z=a.z*h+b.z*c;return d};SQR.Spline=function(a,b,c,d){var e=this;this.rawPoints=[];this.controlPoints=[];var f=1,g=4,h=!1;this.rawPoints.push(a,b,c,d);this.controlPoints.push(a,b,c,d);var i=new SQR.V2,j=function(a,b){return(new SQR.V2).sub(b,a).mul(0.5).appendVec(a)},m=function(a,b,c){var d,g=e.controlPoints;d=Math.floor(a*f);a=a*f-d;d==g.length/4&&(d=Math.max(0,d-1),a=1);d*=4;b=b||i;b.x=c(a,g[d+0].x,g[d+1].x,g[d+2].x,g[d+3].x);b.y=c(a,g[d+0].y,g[d+1].y,g[d+2].y,g[d+3].y);return b};this.valueAt=function(a,b){return m(a,b,
SQR.Interpolation.bezierPosition)};this.velocityAt=function(a,b){return m(a,b,SQR.Interpolation.bezierVelocity)};this.add=function(a,b){this.rawPoints.push(a,b);g=this.rawPoints.length;this.calculateControlPoints()};this.closePath=function(){h=!0;this.calculateControlPoints()};this.calculateControlPoints=function(){if(g<4||g%2==1)throw"Spline is corrupt - illegal number of points (should be an even number and >= 4)";this.controlPoints=[];f=1;for(var a=0;a<g;a++){var b=this.rawPoints[a];if(a<3)if(h&&
a==0){var c=this.rawPoints[a+1];c=j(c,b);this.controlPoints.push(c)}else this.controlPoints.push(b);else a>=3&&a%2==0?this.controlPoints.push(b):a>=3&&a%2==1&&a==g-1&&!h?this.controlPoints.push(b):a>=3&&a%2==1&&a<g-1&&(c=this.rawPoints[a-1],c=j(b,c),this.controlPoints.push(c,c,b),f++)}if(h){a=this.rawPoints[this.rawPoints.length-1];b=this.rawPoints[0];var d=this.rawPoints[1];c=j(a,this.rawPoints[this.rawPoints.length-2]);d=j(b,d);this.controlPoints.push(c,c,a,b,d);f++}}};SQR.Spring=function(a){this.anchor=a||new SQR.V2;this.location=this.anchor.clone();this.acceleration=this.anchor.clone();this.velocity=this.anchor.clone();this.friction=0.85;this.k=0.1;var b=0;this.update=function(){this.acceleration.sub(this.location,this.anchor);b=this.acceleration.mag();this.acceleration.norm().mul(-this.k*b);this.velocity.add(this.velocity,this.acceleration);this.velocity.mul(this.friction);this.location.add(this.location,this.velocity)}};SQR.V2=function(a,b){this.x=a||0;this.y=b||0};SQR.V2.prototype.set=function(a,b){this.x=a||0;this.y=b||0;return this};SQR.V2.prototype.copyTo=function(a){a.x=this.x;a.y=this.y};SQR.V2.prototype.copyFrom=function(a){this.x=a.x;this.y=a.y;return this};SQR.V2.prototype.add=function(a,b){this.x=a.x+b.x;this.y=a.y+b.y;return this};SQR.V2.prototype.sub=function(a,b){this.x=a.x-b.x;this.y=a.y-b.y;return this};SQR.V2.prototype.neg=function(){this.x*=-1;this.y*=-1;return this};
SQR.V2.prototype.appendVec=function(a){if(!a)return this;this.x+=a.x;this.y+=a.y;return this};SQR.V2.prototype.mul=function(a,b){b=b||this;b.x=this.x*a;b.y=this.y*a;return b};SQR.V2.prototype.magsq=function(){return this.x*this.x+this.y*this.y};SQR.V2.prototype.mag=function(){return Math.sqrt(this.magsq())};SQR.V2.prototype.norm=function(){var a=this.mag();if(a==0)return this;this.x/=a;this.y/=a;return this};SQR.V2.prototype.perpendicular=function(){var a=this.x;this.x=-this.y;this.y=a;return this};
SQR.V2.prototype.isZero=function(){return this.x==0&&this.y==0};SQR.V2.random=function(){return new SQR.V2(Math.random()*2-1,Math.random()*2-1)};SQR.V2.prototype.setAngleRadius=function(a,b){this.x=Math.cos(a)*b;this.y=Math.sin(a)*b;return this};SQR.V2.prototype.append=function(a,b){this.x+=a;this.y+=b;return this};SQR.V2.prototype.addAngleRadius=function(a,b){this.x+=Math.cos(a)*b;this.y+=Math.sin(a)*b;return this};SQR.V2.prototype.clone=function(){return new SQR.V2(this.x,this.y)};
SQR.V2.dot=function(a,b){return a.x*b.x+a.y*b.y};SQR.V3=function(a,b,c,d){this.x=a||0;this.y=b||0;this.z=c||0;this.w=d||1};SQR.V3.prototype.set=function(a,b,c,d){this.x=a||0;this.y=b||0;this.z=c||0;this.w=d||1;return this};SQR.V3.prototype.append=function(a,b,c,d){this.x+=a||0;this.y+=b||0;this.z+=c||0;this.w+=d||0;return this};SQR.V3.prototype.appendVec=function(a){if(!a)return this;this.x+=a.x;this.y+=a.y;this.z+=a.z;this.w+=a.w;return this};SQR.V3.prototype.copyTo=function(a){a.x=this.x;a.y=this.y;a.z=this.z;a.w=this.w;return a};
SQR.V3.prototype.copy=function(a){a=a||new SQR.V3;a.set(this.x,this.y,this.z,this.w);return a};SQR.V3.prototype.copyFrom=function(a){this.x=a.x;this.y=a.y;this.z=a.z;this.w=a.w;return this};SQR.V3.prototype.magsq=function(){return this.x*this.x+this.y*this.y+this.z*this.z};SQR.V3.prototype.mag=function(){return Math.sqrt(this.magsq())};SQR.V3.prototype.isZero=function(){return this.x==0&&this.y==0&&this.z==0};SQR.V3.prototype.mul=function(a){this.x*=a;this.y*=a;this.z*=a;return this};
SQR.V3.prototype.neg=function(){this.x=-this.x;this.y=-this.y;this.z=-this.z;return this};SQR.V3.prototype.norm=function(){var a=1/this.mag();this.set(this.x*a,this.y*a,this.z*a);return this};SQR.V3.prototype.add=function(a,b){this.x=a.x+b.x;this.y=a.y+b.y;this.z=a.z+b.z;return this};SQR.V3.prototype.sub=function(a,b){this.x=a.x-b.x;this.y=a.y-b.y;this.z=a.z-b.z;return this};SQR.V3.dot=function(a,b){return a.x*b.x+a.y*b.y+a.z*b.z};
SQR.V3.prototype.clone=function(){return new SQR.V3(this.x,this.y,this.z)};SQR.V3.prototype.cross=function(a,b){this.set(a.y*b.z-a.z*b.y,a.z*b.x-a.x*b.z,a.x*b.y-a.y*b.x,this.w);return this};SQR.V3.up=new SQR.V3(0,1,0);SQR.V3.forward=new SQR.V3(0,0,-1);SQR.VectorUtil={mouseToUnitSphereVector:function(a,b,c,d){c=c||0.5;d=d||new SQR.V3;a/=c;b/=c;c=a*a+b*b;c>=1?d.set(a,b,0):d.set(a,b,Math.sqrt(1-c));d.norm();return d}};SQR.Quaternion.__tv1=new SQR.V3;SQR.Quaternion.__tv2=new SQR.V3;SQR.Quaternion.__tv3=new SQR.V3;SQR.Matrix2D.__temp=new Float32Array(9);SQR.Matrix33.__temp=new Float32Array(9);SQR.Matrix44.__temp=new Float32Array(16);SQR.Matrix44.__tv1=new SQR.V3;SQR.Matrix44.__tv2=new SQR.V3;SQR.Matrix44.__tv3=new SQR.V3;SQR.VectorUtil.__tv1=new SQR.V3;
SQR.VectorUtil.__tv2=new SQR.V3;SQR.VectorUtil.__tv3=new SQR.V3;PieSlice=function(){this.endRadius=this.startRadius=this.center=this.angularWidth=this.startAngle=0;this.color=null;this.margin=0;this.stroke=!1;this.draw=function(a){var b=this.angularWidth-this.margin/this.startRadius;a.setTransform(1,0,0,1,0,0);a.translate(this.center.x,this.center.y);a.rotate(this.startAngle);a.translate(-this.center.x,-this.center.y);a.strokeStyle=this.color;a.fillStyle=this.color;a.beginPath();a.moveTo(this.center.x+this.startRadius,this.center.y);a.lineTo(this.center.x+this.endRadius,
this.center.y);a.arc(this.center.x,this.center.y,this.endRadius,0,b);a.lineTo(this.center.x+Math.cos(b)*this.startRadius,this.center.y+Math.sin(b)*this.startRadius);a.arc(this.center.x,this.center.y,this.startRadius,this.angularWidth,0,!0);this.stroke?a.stroke():a.fill()}};SQR.CSSCollider=function(a,b){function c(a,b,c,d){o.transformVector(a,b);b.x=b.x/b.z*c+c;b.y=b.y/b.z*d+d}var d=a*0.5,e=b*0.5,f=new SQR.V3(-d,e,0),g=new SQR.V3(d,e,0),h=new SQR.V3(d,-e,0),i=new SQR.V3(-d,-e,0),j=new SQR.V3,m=new SQR.V3,n=new SQR.V3,l=new SQR.V3,k=new SQR.V2,o=new SQR.Matrix44;this.project=function(a,b){b.projection.copyTo(o);o.multiply(a.viewMatrix);c(f,j,b.centerX,b.centerY);c(g,m,b.centerX,b.centerY);c(h,n,b.centerX,b.centerY);c(i,l,b.centerX,b.centerY)};this.intersects=function(a,
b){k.set(a,b);var c=q(k,j,m,n),d=q(k,j,n,l);return c||d};var p=function(a,b,c){return(a.x-c.x)*(b.y-c.y)-(b.x-c.x)*(a.y-c.y)},q=function(a,b,c,d){var e=p(a,b,c)<0;c=p(a,c,d)<0;a=p(a,d,b)<0;return e==c&&c==a}};SQR.Particle=function(a){this.position=a=a||new SQR.V2;this.velocity=a.clone().set();this.acceleration=a.clone().set();this.angularAcceleration=this.angularVelocity=0;this.mass=1;this.friction=2;this.bounciness=1;var b=a.clone().set(),c=a.clone().set();this.addForce=function(a){b.copyFrom(a);b.mul(1/this.mass);this.acceleration.appendVec(b)};this.update=function(a){c.copyFrom(this.velocity);c.norm();c.mul(-this.friction);this.addForce(c);this.acceleration.mul(a||1);this.velocity.appendVec(this.acceleration);
this.position.appendVec(this.velocity);this.acceleration.set()}};SQR.DOMElement2D=function(a){this.isDom2d=!0;this.element=a;var b=!1,c=null,d=new SQR.Matrix2D,e=new SQR.Matrix44,f=new SQR.V3(0,0,0);this.appendToDom=function(a){b&&a==c||(c=a,c.appendChild(this.element),b=!0)};this.removeFromDom=function(){b&&(c.removeChild(this.element),b=!1)};this.setBackfaceVisibility=function(){};this.draw=function(b,c){c.projection.copyTo(e);e.multiply(b.viewMatrix);var i=f.set(0,0,0);e.transformVector(i);i.x=i.x/i.z*c.centerX;i.y=i.y/i.z*c.centerY;var j=1/(i.z/c.cssDistance);
d.setTRS(i.x,i.y,b.rotation.z,j,j);j=(SQR.supportsCss3d?SQR.DOMUtil.translate3dCss(0,0,0):"")+d.getAsCSSProperty(!1);a.style.zIndex=c.depth;a.style.transform=j;a.style["-webkit-transform"]=j;a.style["-moz-transform"]=j;a.style["-o-transform"]=j;a.style["-ms-transform"]=j;a.style.display=i.z<=0?"none":"block"}};SQR.DOMElement3D=function(a){this.isDom3d=!0;this.element=a;var b=!1,c=null;this.setBackfaceVisibility=function(b){b=b?"visible":"hidden";a.style["backface-visibility"]=b;a.style["-webkit-backface-visibility"]=b;a.style["-moz-backface-visibility"]=b;a.style["-ms-backface-visibility"]=b;a.style["-o-backface-visibility"]=b};this.appendToDom=function(a){b&&a==c||(c=a,c.appendChild(this.element),b=!0)};this.removeFromDom=function(){b&&(c.removeChild(this.element),b=!1)};this.draw=function(b,c){var f=
SQR.DOMUtil.translate3dCss(0,0,c.cssDistance),g="perspective("+c.cssDistance+"px)";f=f+" "+b.viewMatrix.getAsCSSProperty();a.style.transform=f;a.style["-webkit-transform"]=f;a.style["-moz-transform"]=f;a.style["-ms-transform"]=g+f;a.style["-o-transform"]=g+f;a.style.zIndex=c.depth}};SQR.Point=function(a){var b=new SQR.V3,c=new SQR.Matrix44;this.draw=function(d,e){var f=e.context,g=d.geometry;e.projection.copyTo(c);c.multiply(d.viewMatrix);for(var h=0;h<g.vertices.length;h++)if(g.vertices[h].copyTo(b),c.transformVector(b),!(b.z<0))b.x=b.x/b.z*e.centerX+e.centerX-a,b.y=b.y/b.z*e.centerY+e.centerY-a,f.drawImage(g.particleTextures[h],b.x,b.y)}};SQR.Polygon=function(){var a=new SQR.Matrix44;new SQR.V3;this.useLight=this.culling=!1;this.draw=function(b,c){var d=c.context,e=b.geometry;c.projection.copyTo(a);a.multiply(b.viewMatrix);var f,g,h=e.polygons.length;for(f=0;f<h;f++)g=e.polygons[f],g.update(a,c.centerX,c.centerY);e.polygons.sort(function(a,b){var c=a.depth,d=b.depth;if(c<d)return 1;if(c>d)return-1;return 0});for(f=0;f<h;f++)if(g=e.polygons[f],!(Math.max(0,SQR.V3.dot(g.normal,SQR.V3.forward))>0&&this.culling)){var i=Math.max(0,SQR.V3.dot(g.normal,
c.lightDirection)),j=g.color||e.color;d.fillStyle=this.useLight?j.applyLight(i):j.toHSLString();d.strokeStyle=this.useLight?j.applyLight(i):j.toHSLString();d.beginPath();d.moveTo(g.sa.x,g.sa.y);d.lineTo(g.sb.x,g.sb.y);d.lineTo(g.sc.x,g.sc.y);g.sd&&d.lineTo(g.sd.x,g.sd.y);d.closePath();d.fill();d.stroke()}}};SQR.Segment=function(a){var b=this;this.culling=!1;var c=new SQR.V3,d=new SQR.V3,e=new SQR.Matrix44,f=new SQR.V3(0,0,1),g=new SQR.V3;this.draw=function(h,i){var j=i.context,m=h.geometry;i.projection.copyTo(e);e.multiply(h.viewMatrix);var n=m.vertices.length;m.continous&&j.beginPath();for(var l=0;l<n;l++)if(!(!m.continous&&l%2==1||m.continous&&!m.closed&&l==n-1)){var k=l==n-1?0:l+1;m.vertices[l].copyTo(c);m.vertices[k].copyTo(d);j.strokeStyle=(m.colors?m.colors[l/2|0]:m.color).toHSLString();j.lineWidth=
a;k=c;var o=d,p=i.centerX,q=i.centerY;e.transformVector(k);e.transformVector(o);k.z<0||o.z<0?k=!1:(g.sub(k,o).norm(),SQR.V3.dot(g,f)<0&&b.culling?k=!1:(k.x=k.x/k.z*p+p,k.y=k.y/k.z*q+q,o.x=o.x/o.z*p+p,o.y=o.y/o.z*q+q,k=!0));k&&(k=j,o=c,p=d,m.continous?l==0?k.moveTo(o.x,o.y):k.lineTo(o.x,o.y):(k.beginPath(),k.moveTo(o.x,o.y),k.lineTo(p.x,p.y),k.stroke()))}m.continous&&(m.closed&&j.closePath(),j.stroke())}};SQR.CanvasUtil={getPixel:function(a,b,c){b=(c*a.width+b)*4;return[a.data[b+0],a.data[b+1],a.data[b+2],a.data[b+3]]},getPixelRed:function(a,b,c){return a.data[(c*a.width+b)*4]},getPixelNormRed:function(a,b,c){return a.data[((c*(a.height-1)|0)*a.width+(b*(a.width-1)|0))*4]}};SQR.Color=function(a,b,c,d){this.set=function(a,b,c,d){this.hue=a;this.saturation=b;this.lightness=c;this.alpha=d};this.applyLight=function(a){return SQR.Color.hsl(this.hue,this.saturation,this.lightness-60+80*a,this.alpha)};this.toHSLString=function(){return SQR.Color.hsl(this.hue,this.saturation,this.lightness,this.alpha)};this.set(a,b,c,d)};SQR.Color.hsl=function(a,b,c,d){return d?"hsla("+a+","+b+"%,"+c+"%, "+d+")":"hsl("+a+","+b+"%,"+c+"%)"};SQR.DOMUtil={translate3dCss:function(a,b,c){return" translate3d("+a+"px,"+b+"px,"+c+"px)"}};SQR.Interactor=function(){var a=this;this.centerY=this.centerX=this.normY=this.normX=this.absPageY=this.absPageX=this.pageY=this.pageX=0;var b=function(b){a.pageX=b.pageX;a.pageY=b.pageY;a.pageCenterX=b.pageX-window.innerWidth*0.5;a.pageCenterY=b.pageY-window.innerHeight*0.5;a.absPageX=b.clientX;a.absPageY=b.clientY;a.normX=b.pageX/window.innerWidth;a.normY=b.pageY/window.innerHeight;a.centerX=a.normX*2-1;a.centerY=a.normY*2-1};this.destroy=function(){document.removeEventListener("mousemove",b,null)};
document.addEventListener("mousemove",b,null)};SQR.Stringify={v2:function(a){return a.x+" | "+a.y},v3:function(a){return a.x+" | "+a.y+" | "+a.z},q:function(a){return a.w+" || "+a.x+" | "+a.y+" | "+a.z},m33:function(a){a=a.data||a;return a[0]+"\t|\t"+a[1]+"\t|\t"+a[2]+"\n"+a[3]+"\t|\t"+a[4]+"\t|\t"+a[5]+"\n"+a[6]+"\t|\t"+a[7]+"\t|\t"+a[8]+"\n"},m44:function(a){var b=a.data||a;a=function(a){a=Math.abs(b[a])>1.0E-4?b[a]:0;return a=a.toPrecision(3)};return a(0)+"\t|\t"+a(4)+"\t|\t"+a(8)+"\t|\t"+a(12)+"\n"+a(1)+"\t|\t"+a(5)+"\t|\t"+a(9)+"\t|\t"+a(13)+
"\n"+a(2)+"\t|\t"+a(6)+"\t|\t"+a(10)+"\t|\t"+a(14)+"\n"+a(3)+"\t|\t"+a(7)+"\t|\t"+a(11)+"\t|\t"+a(15)+"\n"}};SQR.Time={};SQR.Time.time=0;SQR.Time.startTime=0;SQR.Time.timeOffset=0;SQR.Time.lastTime=0;SQR.Time.deltaTime=0;SQR.Time.tick=function(){var a=(new Date).getTime();if(SQR.Time.startTime==0)SQR.Time.startTime=a;if(SQR.Time.lastTime!=0)SQR.Time.deltaTime=a-SQR.Time.lastTime;SQR.Time.lastTime=a;SQR.Time.time=(a-SQR.Time.startTime)/1E3;SQR.Time.deltaTime/=1E3};SQR.Time.getTime=function(){SQR.Time.tick();return SQR.Time.deltaTime};SQR.Time.pause=function(){SQR.Time.timeOffset=(new Date).getTime()};
SQR.Time.resume=function(){SQR.Time.startTime+=(new Date).getTime()-SQR.Time.timeOffset;SQR.Time.lastTime=SQR.Time.deltaTime=0};SQR.Time.formatTime=function(a,b){if(!a)a=SQR.Time.time;var c=Math.floor(a%1*100),d=Math.floor(a)%60,e=Math.floor(a/60);c<10&&(c="0"+c);c==100&&(c="00");d<10&&(d="0"+d);e<10&&(e="0"+e);return b?e+":"+d+":"+c:e+":"+d};
