SQR.GeometryTools=function(){var e={};return e.batch=function(e){var t=[],n=0,r=function(a){if(a.transformWorld(),a.numChildren>0)for(var o=0;o<a.numChildren;o++)r(a.children[o]);a.buffer&&(a.buffer.isIndexed()?console.warn("> SQR.GeometryTools.batch - indexed buffers can't be batched"):(t.push(a),n+=a.buffer.size)),a.shader&&(e.shader=a.shader)};r(e);for(var a=SQR.Buffer().layout(t[0].buffer.layout,n),o=0,i=0,u=new SQR.V3,d=new SQR.Matrix33,s=0,c=0;c<t.length;c++){var f=t[c],l=t[c].buffer,m=new Float32Array(l.size*l.strideSize);m.set(l.getDataArray()),l.iterate("aPosition",function(e,t){u.set(t[e+0],t[e+1],t[e+2],1),f.globalMatrix.transformVector(u),m[e+0]=u.x,m[e+1]=u.y,m[e+2]=u.z}),l.iterate("aNormal",function(e,t){u.set(t[e+0],t[e+1],t[e+2]),f.globalMatrix.inverseMat3(d),d.transformVector(u),m[e+0]=u.x,m[e+1]=u.y,m[e+2]=u.z}),a.setRawData(m,o-i),o+=l.size*l.strideSize,s++}e.removeAll(),e.buffer=a.update()},e}(),SQR.SpriteSheet=function(){var e,t,n,r,a={},o=document.createElement("canvas"),i=o.getContext("2d");return a.canvas=o,a.layout=function(r,i,u){return e=r,t=i,n=u,o.width=t*n,o.height=e*n,a.numFrames=e*t,a.rows=e,a.cols=t,a.size=n,a},a.options=function(e){return r=e,a},a.renderToCanvas=function(e,r){var a=1==t?r:Math.floor(r/t),i=r%t;e.drawImage(o,i*n,a*n,n,n,0,0,n,n)},a.draw=function(o){if(r&&void 0!==r.bgcolor?(i.fillStyle=r.bgcolor,i.fillRect(0,0,t*n,e*n)):(i.fillStyle="rgba(0, 0, 0, 0)",i.fillRect(0,0,t*n,e*n)),!o)return a;for(var u=0;e>u;u++)for(var d=0;t>d;d++){i.save();var s=r&&r.webglFlipY?(e-u-1)*n:u*n;i.translate(d*n,s),o(i,u*t+d,a.numFrames),i.restore()}return a},a},SQR.TextureGenerator={noise:function(e,t,n,r,a){e=e||512,t=t||e,r=r||0,a=a||255;var o=n||document.createElement("canvas");o.width=e,o.height=t;for(var i=o.getContext("2d"),u=i.createImageData(e,t),d=u.data,s=0,c=d.length;c>s;s+=4)d[s+0]=r+Math.random()*(a-r)|0,d[s+1]=r+Math.random()*(a-r)|0,d[s+2]=r+Math.random()*(a-r)|0,d[s+3]=255;return i.putImageData(u,0,0),o}},SQR.Trackball=function(){var e={};e.rotation=new SQR.Quaternion;var t=function(e,t,n,r){n=n||.5,r=r||new SQR.V3;var a=e/n,o=t/n,i=a*a+o*o;return i>=1?r.set(a,o,0):r.set(a,o,Math.sqrt(1-i)),r.norm(),r},n=0,r=0,a=!1,o=new SQR.V3,i=new SQR.V3,u=new SQR.Quaternion,d=window.innerWidth/window.innerHeight,s=function(e){e="ontouchstart"in document?e.targetTouches[0]:e,n=(e.pageX/window.innerWidth*2-1)*d,r=-1*(e.pageY/window.innerHeight*2-1)},c=function(e){a=!0,s(e),t(n,r,1,o)},f=function(d){if(a){s(d),t(n,r,1,i);var c=SQR.V3.dot(o,i);o.cross(i,o),u.set(o.x,o.y,o.z,c),e.rotation.mul(u),o.copyFrom(i)}},l=function(){a=!1};return"ontouchstart"in document?(document.addEventListener("touchstart",c,!1),document.addEventListener("touchmove",f,!1),document.addEventListener("touchend",l,!1)):(document.addEventListener("mousedown",c,!1),document.addEventListener("mousemove",f,!1),document.addEventListener("mouseup",l,!1)),e};