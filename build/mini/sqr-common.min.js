SQR={TWOPI:2*Math.PI,HALFPI:.5*Math.PI,EPSILON:1e-6,gl:null,fullScreenQuad:null,shaderPath:".",Primitives:{},v2u2:function(){return{aPosition:2,aUV:2}},v2c3:function(){return{aPosition:2,aColor:3}},v3n3:function(){return{aPosition:3,aNormal:3}},v3n3u2:function(){return{aPosition:3,aNormal:3,aUV:2}},WARN_UNIFORM_NOT_PRESENT:!1},SQR.Version={version:"3",build:2,date:"2014-12-10T09:03:06.463Z"},SQR.Buffer=function(){var e,r,t,a,n={},i=!1;return n.mode=SQR.gl.TRIANGLES,n.setMode=function(e){return n.mode=e,n},n.layout=function(r,t){n.size=t,n.strideSize=0,n.attributes=r;for(var a in r){var i={offset:n.strideSize,byteOffset:4*n.strideSize,size:r[a]};n.strideSize+=r[a],r[a]=i}return n.strideByteSize=4*n.strideSize,e=new Float32Array(t*n.strideSize),n},n.data=function(r,t){t instanceof Array||(t=Array.prototype.slice.call(arguments,1));for(var a=n.attributes[r],i=t.length/a.size,o=0;i>o;o++)for(var u=0;u<a.size;u++)e[o*n.strideSize+u+a.offset]=t[o*a.size+u];return n},n.set=function(r,t,a){a.toArray?a=a.toArray():a instanceof Array||(a=Array.prototype.slice.call(arguments,2));for(var i=n.attributes[r],o=0;o<i.size;o++)e[t*n.strideSize+o+i.offset]=a[o];return n},n.iterate=function(r,t){for(var a=n.attributes[r],i=0,o=0;o<e.length;o+=n.strideSize)t(o+a.offset,e,i),i++;return n},n.bind=function(){return SQR.gl.bindBuffer(SQR.gl.ARRAY_BUFFER,t),n},n.update=function(){var o=SQR.gl;return t=t||o.createBuffer(),o.bindBuffer(o.ARRAY_BUFFER,t),o.bufferData(o.ARRAY_BUFFER,e,o.STATIC_DRAW),i&&(a=o.createBuffer(),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,a),o.bufferData(o.ELEMENT_ARRAY_BUFFER,r,o.STATIC_DRAW)),n},n.index=function(e){return e instanceof Array||(e=Array.prototype.slice.call(arguments,0)),r=new Uint16Array(e),n.indexSize=e.length,i=!0,n},n.draw=function(){var e=SQR.gl;i?e.drawElements(n.mode,n.indexSize,e.UNSIGNED_SHORT,0):e.drawArrays(n.mode,0,n.size)},n.getDataArray=function(){return e},n},SQR.Context=function(e){e||(e=document.createElement("canvas")),e instanceof HTMLElement||(e=document.querySelector(e));var r,t={canvas:e};return t.create=function(){return r=e.getContext("experimental-webgl",{antialias:!0}),t.gl=r,t.setAsCurrent(),t},t.size=function(a,n){return e.width=a,e.height=n,r.viewport(0,0,a,n),t},t.clearColor=function(e,a,n,i){return r.clearColor(e,a,n,i),t},t.clear=function(){return r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),t},t.setAsCurrent=function(){return SQR.gl=r,t},t},SQR.FrameBuffer=function(e,r,t){t=t||1;var a={},n=SQR.gl;return a.fbo=n.createFramebuffer(),a.texture=n.createTexture(),a.depthBuffer=n.createRenderbuffer(),n.bindFramebuffer(n.FRAMEBUFFER,a.fbo),n.bindTexture(n.TEXTURE_2D,a.texture),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,e,r,0,n.RGBA,n.UNSIGNED_BYTE,null),n.bindRenderbuffer(n.RENDERBUFFER,a.depthBuffer),n.renderbufferStorage(n.RENDERBUFFER,n.DEPTH_COMPONENT16,e,r),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,a.texture,0),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.RENDERBUFFER,a.depthBuffer),n.bindTexture(n.TEXTURE_2D,null),n.bindRenderbuffer(n.RENDERBUFFER,null),n.bindFramebuffer(n.FRAMEBUFFER,null),a.bind=function(){n.viewport(0,0,e,r),n.bindFramebuffer(n.FRAMEBUFFER,a.fbo)},a.resize=function(){e=e*t|0,r=r*t|0,n.bindFramebuffer(n.FRAMEBUFFER,a.fbo),n.bindTexture(n.TEXTURE_2D,a.texture),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,e,r,0,n.RGBA,n.UNSIGNED_BYTE,null),n.bindRenderbuffer(n.RENDERBUFFER,a.depthBuffer),n.renderbufferStorage(n.RENDERBUFFER,n.DEPTH_COMPONENT16,e,r)},a},SQR.Loader={loadText:function(e,r){var t=new XMLHttpRequest;t.open("GET",e),t.addEventListener("readystatechange",function(){4==t.readyState&&(t.removeEventListener("readystatechange"),r(t.responseText,e))}),t.send()},loadJSON:function(e,r){SQR.Loader.loadText(e,function(t){r(JSON.parse(t),e)})},loadImage:function(e,r){var t=new Image;if(r){var a=function(){t.removeEventListener("load",a),r(t,e)};t.addEventListener("load",a)}return t.src=e,t},loadWebcam:function(e){navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia||(console.warn("getUserMedia not supported"),e());var r={audio:!1,video:{}},t=function(e){n.strea=e,n.src=window.URL.createObjectURL(e),n.play(),n.addEventListener("canplaythrough",a,!1)},a=function(){e(n,"webcam")},n=document.createElement("video");n.autoplay=!0,navigator.getUserMedia(r,t,function(e){console.warn("getUserMedia error ",e)})},loadVideo:function(e,r){var t=function(){r(a,e)},a=document.createElement("video");a.autoplay=!0,a.addEventListener("canplaythrough",t,!1);var n=e;a.canPlayType("video/mp4")||(n=n.replace("mp4","webm")),a.src=n},loadAssets:function(e,r){var t=e.length;SQR.Loader.assets={};for(var a=function(e,a){SQR.Loader.assets[a]=e,t--,0==t&&r(SQR.Loader.assets)},n=0;t>n;n++){var i=e[n],o=i.substring(i.lastIndexOf(".")+1);if(i.indexOf("~")>-1){if(SQR.GLSL&&SQR.GLSL[i.substring(2)]){t--;continue}i=i.replace("~",SQR.shaderPath)}switch(o){case"glsl":SQR.Loader.loadText(i,a);break;case"png":case"jpg":case"gif":SQR.Loader.loadImage(i,a);break;case"json":case"js":SQR.Loader.loadJSON(i,a);break;case"mp4":case"webm":SQR.Loader.loadVideo(i,a);break;case"webcam":SQR.Loader.loadWebcam(a)}}}},SQR.PostEffect=function(e){SQR.fullScreenQuad=SQR.fullScreenQuad||SQR.Buffer().layout(SQR.v2u2(),6).data("aPosition",-1,1,1,1,1,-1,-1,1,1,-1,-1,-1).data("aUV",0,1,1,1,1,0,0,1,1,0,0,0).update();var r=new SQR.Transform;return r.buffer=SQR.fullScreenQuad,r.shader=SQR.Shader(e),r},SQR.Renderer=function(e){var r,t,a={},n=[],i=function(e){if(e.active){if(e.transformWorld(),e.numChildren>0)for(var r=0;r<e.numChildren;r++)i(e.children[r]);e.buffer&&e.shader&&n.push(e)}};return a.render=function(o,u,f){var s=SQR.gl;f&&f.dontClear||e.clear(),s.enable(s.DEPTH_TEST),s.enable(s.CULL_FACE),s.frontFace(s.CW),n.length=0,i(o),u&&u.computeInverseMatrix();var c,l=n.length,d=null,R=null,E=f&&f.replacementShader;E&&(R=f.replacementShader.use());for(var T=0;l>T;T++){r=!1,t=!1;var c=n[T];d!=c.buffer&&(d=c.buffer,d.bind(),t=!0),R==c.shader||E||(R=c.shader.use().updateTextures(),R.setUniform("uProjection",a.projection),r=!0),(r||t)&&R.attribPointers(d),c.transformView(u?u.inverseWorldMatrix:null),c.draw(f)}},a.renderToScreen=function(){var e=SQR.gl;e.bindFramebuffer(e.FRAMEBUFFER,null)},a},SQR.Shader=function(e,r){var t,a={},n={},i=[],o={},u=[],f=[],s=function(e){if(!e)throw"> SQR.Shader.parseGLSL - Shader source code missing";for(var r="",t="",a=!0,n=e.split("\n"),i=0;i<n.length;i++){var o=n[i];if(o.indexOf("//#include")>-1){var u,f=o.substring(11);if(u=SQR.GLSL&&SQR.GLSL[f.substring(1)]?SQR.GLSL[f.substring(1)]:SQR.Loader.assets[f.replace("~",SQR.shaderPath)],!u)throw"> SQR.Shader.parseGLSL - Include not found "+f;n[i]=u}}for(var n=n.join("\n").split("\n"),i=0;i<n.length;i++){var o=n[i];if(o.indexOf("//#")>-1)o.indexOf("//#fragment")>-1?a=!1:o.indexOf("//#vertex")>-1&&(a=!0);else{if(o.indexOf("//")>-1&&(o=o.substring(0,o.indexOf("//"))),o.match(/^([\s\t]*)$/))continue;a?r+=o+"\n":t+=o+"\n"}}return{vertex:r,fragment:t}};a.compile=function(){var r=e=s(e),n=SQR.gl,i=n.createShader(n.VERTEX_SHADER);n.shaderSource(i,r.vertex),n.compileShader(i);var o=n.createShader(n.FRAGMENT_SHADER);if(n.shaderSource(o,r.fragment),n.compileShader(o),t=n.createProgram(),n.attachShader(t,i),n.attachShader(t,o),n.linkProgram(t),!n.getShaderParameter(i,n.COMPILE_STATUS))throw"> SQR.Shader. Vertex shader compile error: "+n.getShaderInfoLog(i);if(!n.getShaderParameter(o,n.COMPILE_STATUS))throw"> SQR.Shader. Fragment shader compile error: "+n.getShaderInfoLog(o);if(!n.getProgramParameter(t,n.LINK_STATUS))throw"> SQR.Shader. Shader linking error: "+n.getProgramInfoLog(t);return a},a.inspect=function(){for(var e=SQR.gl,r=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES),s=0;r>s;s++){var c=e.getActiveAttrib(t,s);c.location=e.getAttribLocation(t,c.name),n[c.name]=c,i.push(c)}for(var l=e.getProgramParameter(t,e.ACTIVE_UNIFORMS),d=0,s=0;l>s;s++){var R=e.getActiveUniform(t,s);R.location=e.getUniformLocation(t,R.name),R.type==e.SAMPLER_2D&&(R.texId=d++,f.push(R)),o[R.name]=R,u.push(R)}return a};var c="string";a.getUniform=function(e){return o[e]},a.hasUniform=function(e){return null!=o[e]},a.setUniform=function(e,r){var t=SQR.gl,n=typeof e==c?o[e]:e,i=r;if(!n)return SQR.WARN_UNIFORM_NOT_PRESENT&&(console.warn("> SQR.Shader attempt to set uniform that does not exist: "+e),console.trace()),a;switch(i.toUniform&&(i=i.toUniform(n.type)),n.type){case t.BYTE:t.uniform1i(n.location,i);break;case t.UNSIGNED_BYTE:t.uniform1i(n.location,i);break;case t.SHORT:t.uniform1i(n.location,i);break;case t.UNSIGNED_SHORT:t.uniform1i(n.location,i);break;case t.INT:t.uniform1i(n.location,i);break;case t.INT_VEC2:t.uniform2iv(n.location,i);break;case t.INT_VEC3:t.uniform3iv(n.location,i);break;case t.INT_VEC4:t.uniform4iv(n.location,i);break;case t.UNSIGNED_INT:t.uniform1i(n.location,i);break;case t.FLOAT:t.uniform1f(n.location,i);break;case t.FLOAT_VEC2:t.uniform2fv(n.location,i);break;case t.FLOAT_VEC3:t.uniform3fv(n.location,i);break;case t.FLOAT_VEC4:t.uniform4fv(n.location,i);break;case t.BOOL:t.uniform1i(n.location,i);break;case t.BOOL_VEC2:t.uniform2iv(n.location,i);break;case t.BOOL_VEC3:t.uniform3iv(n.location,i);break;case t.BOOL_VEC4:t.uniform4iv(n.location,i);break;case t.FLOAT_MAT2:t.uniformMatrix2fv(n.location,!1,i.data||i);break;case t.FLOAT_MAT3:t.uniformMatrix3fv(n.location,!1,i.data||i);break;case t.FLOAT_MAT4:t.uniformMatrix4fv(n.location,!1,i.data||i);break;case t.SAMPLER_2D:l(n,i);break;case t.SAMPLER_CUBE:d(n,i);break;default:console.warn("> SQR.Shader > WARNING! Unknown uniform type ( 0x"+n.type.toString(16)+" )")}return a};var l=function(e,r){var t=SQR.gl,a=e.texId;e.texref=r,t.activeTexture(t.TEXTURE0+a),t.bindTexture(t.TEXTURE_2D,r.tex||r),r.isAnimated&&r.update(),t.uniform1i(e.location,a)},d=function(e,r){var t=SQR.gl,a=e.id;e.texref=r,t.activeTexture(t.TEXTURE0+a),t.bindTexture(t.TEXTURE_CUBE_MAP,r.tex||r),t.uniform1i(e.location,a)};return a.updateTextures=function(){for(var e=(SQR.gl,0),r=f.length;r>e;e++){var t=f[e];t.texref&&a.setUniform(t,t.texref)}return a},a.use=function(){return SQR.gl.useProgram(t),a},a.attribPointers=function(e){var r=SQR.gl,t=i.length;e=e.buffer||e;for(var n=0;t>n;n++){var o=i[n],u=e.attributes[o.name];if(!u)throw"> SQR.Shader expects attribute "+o.name+" but geometry doesn't provide it";o.enabled||r.enableVertexAttribArray(o.location),r.vertexAttribPointer(o.location,u.size,r.FLOAT,!1,e.strideByteSize,u.byteOffset),o.enabled=!0}return a},r&&r.doNotCompile||(a.compile(),a.inspect()),a},SQR.Texture=function(e,r){r=r||{};var t={},a=SQR.gl,n=e,i=a.createTexture();t.isAnimated=r&&r.isAnimated||e instanceof HTMLVideoElement;var o=function(){var e=n.width,r=n.height;return e>0&&r>0&&0==(e&e-1)&&0==(r&r-1)};t.update=function(){var e=SQR.gl;return e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,n),t};var u=r.wrapS||r.wrap||a.CLAMP_TO_EDGE,f=r.wrapT||r.wrap||a.CLAMP_TO_EDGE;return a.bindTexture(a.TEXTURE_2D,i),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,n),o()&&a.generateMipmap(a.TEXTURE_2D),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,u),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,f),a.bindTexture(a.TEXTURE_2D,null),t.tex=i,t},SQR.Transform=function(){var e={};e.name="sqr.transform."+SQR.TransformCount++,e.active=!0,e.position=new SQR.V3,e.quaternion=new SQR.Quaternion,e.rotation=new SQR.V3,e.scale=new SQR.V3(1,1,1),e.useQuaternion=!1,e.isStatic=!1,e.directMatrixMode=!1;var r=0;return e.matrix=new SQR.Matrix44,e.normalMatrix=new SQR.Matrix33,e.globalMatrix=new SQR.Matrix44,e.viewMatrix=new SQR.Matrix44,e.inverseWorldMatrix,e.children=[],e.numChildren=0,e.add=function(){for(var r=0;r<arguments.length;r++){var t=arguments[r];t.parent=e,-1==e.children.indexOf(t)&&e.children.push(t)}return e.numChildren=e.children.length,e},e.remove=function(){for(var r=0;r<arguments.length;r++){var t=arguments[r],a=e.children.indexOf(t);if(-1==a)return!1;t.parent=null,e.children.splice(a,1)}return e.numChildren=e.children.length,e},e.contains=function(r){return e.children.indexOf(r)>-1},e.recurse=function(r){r(e);for(var t=0;t<e.numChildren;t++)e.children[t].recurse(r)},e.draw=function(r){var t=r&&r.replacementShader,a=t?r.replacementShader:e.shader;if(a.setUniform("uMatrix",e.viewMatrix),a.setUniform("uViewMatrix",e.viewMatrix),a.setUniform("uNormalMatrix",e.normalMatrix),!t&&e.uniforms)for(var n=Object.keys(e.uniforms),i=0,o=n.length;o>i;i++)a.setUniform(n[i],e.uniforms[n[i]]);e.buffer.draw()},e.transformWorld=function(){if(1!=r){if(!e.directMatrixMode){var t=e.position,a=e.scale;if(e.useQuaternion){var n=e.quaternion;e.matrix.setTQS(t.x,t.y,t.z,n.w,n.x,n.y,n.z,a.x,a.y,a.z)}else{var i=e.rotation;e.matrix.setTRS(t.x,t.y,t.z,i.x,i.y,i.z,a.x,a.y,a.z)}}e.parent?(e.parent.globalMatrix.copyTo(e.globalMatrix),e.globalMatrix.multiply(e.matrix)):e.matrix.copyTo(e.globalMatrix),e.isStatic&&(r=1)}},e.transformView=function(r){r?(r.copyTo(e.viewMatrix),e.viewMatrix.multiply(e.globalMatrix),e.viewMatrix.inverseMat3(e.normalMatrix)):e.globalMatrix.copyTo(e.viewMatrix)},e.computeInverseMatrix=function(){return e.inverseWorldMatrix||(e.inverseWorldMatrix=new SQR.Matrix44),e.globalMatrix.inverse(e.inverseWorldMatrix),e.inverseWorldMatrix},e},SQR.TransformCount=0;