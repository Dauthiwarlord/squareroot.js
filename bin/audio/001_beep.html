<!DOCTYPE html>
<html>
<head>
    <title>Beep | v0.1</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable = no">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <style type="text/css">

	    body {
	    	background-color: #000;
	    	color: #555;
	    	font-family: Arial;
	    	font-size: 24px;
	    	margin: 20px;
	    }

    </style>
</head>
<body>

<canvas width="1024" height="512"></canvas>

<div id="info"></div>

<script type="text/javascript">

window.requestAnimFrame = (function(){
  return  window.requestAnimationFrame       ||
          window.webkitRequestAnimationFrame ||
          window.mozRequestAnimationFrame    ||
          function( callback ){
            window.setTimeout(callback, 1000 / 60);
          };
})();

var mouseX = 0, mouseY = 0;

var infoTag = document.querySelector('#info');
function info() {
	var m = "";

	for(var i = 0; i < arguments.length; i++) {
		m += arguments[i] + "<br>";
	}

	infoTag.innerHTML = m;
}

// var canvas = document.querySelector("canvas");
// var ctx = canvas.getContext('2d');

var makeSineWave = function(context, destination, channel) {

	var that = this;
	var x = 0;

	var beat = 0, amp = 0, _amp = 0;
	var freq = 0, fade = 0;
	var twoPI = Math.PI * 2;

	var fire = function(_freq, _fade) {
		freq = _freq;
		fade = _fade;
		beat = 1;
		x = 0;
	};

	var node = context.createJavaScriptNode(1024, 1, 2);
	var sampleRate = context.sampleRate / 2 * Math.PI;
	
	var process = function(e) {
		var dataLeft = e.outputBuffer.getChannelData(0);
		var dataRight = e.outputBuffer.getChannelData(1);

		beat *= fade;
		amp = (beat - amp) * 0.2;

		var dl = dataLeft.length;
		var f = freq / sampleRate;

		for (var i = 0; i < dl; ++i) {

			var m1 = x * f;
			var a1 = m1 % twoPI;

			if(Math.abs(a1) < f) {
				_amp = amp;
				x = 0;
			}

			dataLeft[i] = _amp * Math.sin(m1);
			dataRight[i] = _amp * Math.sin(m1) * 0.5;

			x++;
		}
	}

	return {
		fire: fire,
		start: function() {
			node.onaudioprocess = process;
			node.connect(destination);
		}
	}
	
}

var context = new webkitAudioContext();

var waves = [], numWaves = 20;
var notes = [];
var rythm = 300;

var filter = context.createBiquadFilter();
filter.type = filter.LOWSHELF;
filter.frequency.value = 0;
filter.Q.value = 256;

var volume = context.createGainNode();

var delay = context.createDelayNode();
delay.delayTime.value = 0.2;

var feedback = context.createGainNode();
feedback.gain.value = 0.9;

filter.connect(volume);

// filter.connect(delay);
// delay.connect(feedback);
// feedback.connect(volume);
// feedback.connect(delay);

volume.connect(context.destination);

document.addEventListener("mousemove", function(e) {
	mouseX = e.pageX / window.innerWidth;
	mouseY = e.pageY / window.innerHeight;
	// filter.frequency.value = 200 + e.pageX;
});




for(var i = 0; i < numWaves; i++) {

	var n = 1024 + Math.random() * 4096;
	notes.push(n);

	var w = makeSineWave(context, filter, n > 2048);
	w.start();
	waves.push(w); 	
}

var c = 0;
var run = function() {
	requestAnimFrame(run);
	c++;

	for(var i = 0; i < numWaves; i++) {
		var w = waves[i];
		var n = notes[i];

		if(c % rythm == i * (rythm/numWaves)) {
			if(n) w.fire(n, 0.9);
		}
	}
}

run();

</script>
<script>

if(
	document.write('<script src="http://' + (location.host || 'localhost').split(':')[0] + ':35729/livereload.js?snipver=1"></' + 'script>')

</script>
</body>











