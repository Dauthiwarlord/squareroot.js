<!DOCTYPE html>
<html>
<head>
<title>Hairy Ball | v0.10</title>

<script type="text/javascript" src="../lib/requestAnimFrame.js"></script>

<script type="text/javascript" src="../src/SQR.js"></script>

<script type="text/javascript" src="../src/engine/Engine.js"></script>
<script type="text/javascript" src="../src/engine/Transform.js"></script>
<script type="text/javascript" src="../src/engine/Geometry.js"></script>
<script type="text/javascript" src="../src/engine/renderers/DOMElement.js"></script>
<script type="text/javascript" src="../src/engine/renderers/Particle.js"></script>
<script type="text/javascript" src="../src/engine/renderers/Segment.js"></script>

<script type="text/javascript" src="../src/math/Vector2.js"></script>
<script type="text/javascript" src="../src/math/Vector3.js"></script>
<script type="text/javascript" src="../src/math/ProjectionMatrix.js"></script>
<script type="text/javascript" src="../src/math/Matrix44.js"></script>

<script type="text/javascript" src="../src/engine/util/Stringify.js"></script>
<script type="text/javascript" src="../src/engine/util/DOMUtil.js"></script>
<script type="text/javascript" src="../src/engine/util/Time.js"></script>
<script type="text/javascript" src="../src/engine/util/Color.js"></script>

<script type="text/javascript" src="../lib/FastBlur.js"></script>

<style type="text/css">

    body {
        overflow: hidden;
        color: #ffffff;
    }

    #canvas, #debug {
        position: absolute;
        top: 0px;
        left: 0px;
    }

    #map-container {
        position: absolute;
        top: 10px;
        left: 10px;
        display: none;
    }

</style>

<script type="text/javascript">

    var engine, camera, hairyBall;
    var a = 0;

    window.onload = function() {

        document.addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, false);

        engine = new SQR.Engine(document.getElementById('canvas'), document.getElementById("div-container"));

        engine.setSize(window.innerWidth, window.innerHeight);

        engine.setProjection(60);

        engine.setBackground("#000000");
        engine.setClearColor("rgba(0,0,0,0.2)");

//        engine.setBackground("#ffffff");
//        engine.setClearColor("rgba(255,255,255,0.4)");

        camera = new SQR.Transform();
        camera.position.z = 250;
//            camera.position.x = -100;
        engine.add(camera);

        hairyBall = new SQR.Transform();
        hairyBall.directMatrixMode = true;
        hairyBall.renderer = new SQR.Segment(2);
        hairyBall.geometry = new SQR.Geometry();

        var innerRadius = 70;
        var outerRadius = 75;
        var radiusVariance = 6;
        var minLength = 2;

        var maxSegmentsX = 80;
        var segmentsY = 40;

        var phiStart = 0;
        var phiLength = SQR.twoPI;
        var thetaStart = 0;
        var thetaLength = Math.PI;

        var x, y;

        var maptemplate = document.getElementById('map');
        var mapDethTemplate = document.getElementById('depth');

        var earthmap = document.createElement('canvas');
        earthmap.width = maptemplate.width;
        earthmap.height = maptemplate.height;
        var ectx = earthmap.getContext('2d');

        ectx.drawImage(mapDethTemplate, 0, 0);
        var depthpixels = ectx.getImageData(0, 0, earthmap.width, earthmap.height);

        ectx.drawImage(maptemplate, 0, 0);
        var earthpixels = ectx.getImageData(0, 0, earthmap.width, earthmap.height);


        document.getElementById('map-container').appendChild(earthmap);

        var createdPins = 0;
        var oddPin = 0;

        for (y = 0; y <= segmentsY; y ++) {

            var v = y / segmentsY;
            var ring = 1 - Math.abs(v - 0.5) * 2;
            var segmentsX = (ring < 0.25) ? maxSegmentsX * ring : maxSegmentsX;

            for (x = 0; x <= segmentsX; x ++) {

                var u = x / segmentsX;

                var px = ( (1 - v) * earthmap.height) | 0;
                var py = (u * earthmap.width) | 0;

                var pi = (px * earthmap.width + py) * 4;

                var isLand = earthpixels.data[pi + 0] > 128;
                var landHeight = depthpixels.data[pi + 0] / 255;
                landHeight = Math.sqrt(landHeight);

                earthpixels.data[pi + 0] = 255;
                earthpixels.data[pi + 1] = 0;
                earthpixels.data[pi + 2] = 0;
                earthpixels.data[pi + 3] = 255;

                oddPin++;

                if (!isLand) {
                    //continue;
                    if (oddPin % 5 != 0) continue;
                }

                var xp = -Math.cos(phiStart + u * phiLength) * Math.sin(thetaStart + v * thetaLength);
                var yp = Math.cos(thetaStart + v * thetaLength);
                var zp = Math.sin(phiStart + u * phiLength) * Math.sin(thetaStart + v * thetaLength);

                var s = new SQR.V3(xp, yp, zp).mul(innerRadius);

                // var e = new SQR.V3(xp, yp, zp).mul(innerRadius + 1 + radiusVariance * Math.random());
                var outerRadius = (isLand) ? innerRadius + minLength + radiusVariance * landHeight : innerRadius + minLength;
                var e = new SQR.V3(xp, yp, zp).mul(outerRadius);

                var c = (isLand) ? SQR.Color.hsl(100 - landHeight * 100, 100, 50) : SQR.Color.hsl(200 + Math.random() * 40, 100, 50);
//                var c = (isLand) ? SQR.Color.hsl(100 - landHeight * 100, 50, 10) : SQR.Color.hsl(200 + Math.random() * 40, 100, 80);

                hairyBall.geometry.addSegment(s, e, c);
                createdPins++;
            }
        }

        //console.log(createdPins);
        //ectx.putImageData(earthpixels, 0, 0);

        document.addEventListener('touchstart', onTouchStart, false);
        document.addEventListener('touchmove', onTouchMove, false);
        document.addEventListener('touchend', onTouchEnd, false);

        engine.add(hairyBall);

        render();
    }

    function onTouchStart() {

    }

    function onTouchMove() {

    }

    function onTouchEnd() {

    }

    function render() {
        requestAnimFrame(render);
        a += SQR.Time.deltaTime * 0.4;
        //hairyBall.matrix.setTRS(0, 0, 0, a, a / 2, a / 4, an, an, an);
        hairyBall.matrix.setTRS(0, 0, 0, Math.sin(a * 2) / 4, a, 0, 1, 1, 1);

        engine.render(camera);
    }

</script>

</head>
<body>
<div id="canvas-container">
    <canvas id="canvas"></canvas>
</div>
<div id="div-container"></div>

<div id="map-container">
    <img id="map" src="assets/map.jpg"><br>
    <img id="depth" src="assets/map-height-noa.jpg"><br>
</div>
</body>
</html>