<!DOCTYPE html>
<html>
<head>
<title>Hairy globe | v0.25</title>

<!-- SQRLIB -->
<!-- Auto-generated by tools/demojstags.py. Do not edit this section -->
<script type="text/javascript" src="../build/squareroot-min.js"></script>
<!-- SQRLIB -->

<style type="text/css">

    body {
        overflow: hidden;
        color: #ffffff;
    }

    #canvas, #debug {
        position: absolute;
        top: 0px;
        left: 0px;
    }

    #map-container {
        position: absolute;
        top: 10px;
        left: 10px;
        display: none;
    }

    #instr {
        position: absolute;
        top: 10px;
        left: 10px;
        font-family: Georgia, sans-serif;
        color: #ffffff;
        font-size: 14px;
    }

</style>

<script type="text/javascript">

    var engine, camera, hairyBall, aspect;
    var maptemplate, mapDepthTemplate;

    window.onload = function() {
        maptemplate = new Image();
        maptemplate.onload = function() {
            mapDepthTemplate = new Image();
            mapDepthTemplate.onload = function() {
                setup();
            }
            mapDepthTemplate.src = 'assets/map-height-noa.jpg';
        }
        maptemplate.src = 'assets/map.jpg';
    }

    window.setup = function() {
        document.addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, false);

        engine = new SQR.Squareroot(document.getElementById('canvas'), document.getElementById("div-container"));

        engine.setSize(window.innerWidth, window.innerHeight);

        engine.setProjection(60);

        engine.setBackground("#000000");
        //engine.setClearColor("rgba(0,0,0,0.2)");

        camera = new SQR.Transform();
        camera.position.z = 200;
        engine.add(camera);

        hairyBall = new SQR.Transform();
        hairyBall.useQuaternion = true;
        hairyBall.renderer = new SQR.Segment(2);
        hairyBall.renderer.culling = true;
        hairyBall.geometry = new SQR.Geometry();

        var innerRadius = 70;
        var outerRadius = 75;
        var radiusVariance = 6;
        var minLength = 2;

        var maxSegmentsX = 80;
        var segmentsY = 40;

        var phiStart = 0;
        var phiLength = SQR.twoPI;
        var thetaStart = 0;
        var thetaLength = Math.PI;

        var x, y;

        var earthmap = document.createElement('canvas');
        earthmap.width = maptemplate.width;
        earthmap.height = maptemplate.height;
        var ectx = earthmap.getContext('2d');

        ectx.drawImage(mapDepthTemplate, 0, 0);

        var depthpixels = ectx.getImageData(0, 0, earthmap.width, earthmap.height);

        ectx.drawImage(maptemplate, 0, 0);
        var earthpixels = ectx.getImageData(0, 0, earthmap.width, earthmap.height);

        var createdPins = 0;
        var oddPin = 0;

        for (y = 0; y <= segmentsY; y ++) {

            var v = y / segmentsY;
            var ring = 1 - Math.abs(v - 0.5) * 2;
            var segmentsX = (ring < 0.25) ? maxSegmentsX * ring : maxSegmentsX;

            for (x = 0; x <= segmentsX; x ++) {

                var u = x / segmentsX;

                var px = ( (1 - v) * earthmap.height) | 0;
                var py = (u * earthmap.width) | 0;

                var pi = (px * earthmap.width + py) * 4;

                var isLand = earthpixels.data[pi + 0] > 128;
                var landHeight = depthpixels.data[pi + 0] / 255;
                landHeight = Math.sqrt(landHeight);

                earthpixels.data[pi + 0] = 255;
                earthpixels.data[pi + 1] = 0;
                earthpixels.data[pi + 2] = 0;
                earthpixels.data[pi + 3] = 255;

                oddPin++;

                if (!isLand) {
                    //continue;
                    if (oddPin % 5 != 0) continue;
                }

                var xp = -Math.cos(phiStart + u * phiLength) * Math.sin(thetaStart + v * thetaLength);
                var yp = Math.cos(thetaStart + v * thetaLength);
                var zp = Math.sin(phiStart + u * phiLength) * Math.sin(thetaStart + v * thetaLength);

                var s = new SQR.V3(xp, yp, zp).mul(innerRadius);

                // var e = new SQR.V3(xp, yp, zp).mul(innerRadius + 1 + radiusVariance * Math.random());
                var outerRadius = (isLand) ? innerRadius + minLength + radiusVariance * landHeight : innerRadius + minLength;
                var e = new SQR.V3(xp, yp, zp).mul(outerRadius);

                var c = (isLand) ? SQR.Color.hsl(100 - landHeight * 100, 100, 50) : SQR.Color.hsl(200 + Math.random() * 40, 100, 50);
//                var c = (isLand) ? SQR.Color.hsl(100 - landHeight * 100, 50, 10) : SQR.Color.hsl(200 + Math.random() * 40, 100, 80);

                hairyBall.geometry.addSegment(s, e, c);
                createdPins++;
            }
        }

        //console.log(createdPins);
        //ectx.putImageData(earthpixels, 0, 0);

        aspect = window.innerWidth / window.innerHeight;
        lastMV = new SQR.V3();
        currMV = new SQR.V3();
        deltaR = new SQR.Quaternion();

        document.addEventListener('touchstart', onInteractionStart, false);
        document.addEventListener('touchmove', onInteractionMove, false);
        document.addEventListener('touchend', onInteractionEnd, false);

        document.addEventListener('mousedown', onInteractionStart, false);
        document.addEventListener('mousemove', onInteractionMove, false);
        document.addEventListener('mouseup', onInteractionEnd, false);

        engine.add(hairyBall);
        render(true);
    }

    var mx = 0, my = 0, isDown = false, isTracked = false;;
    var lastMV, currMV, deltaR;

    function onInteractionStart() {
        isDown = true;
    }

    function onInteractionMove(e) {
        if (isDown) {
            e = ('ontouchstart' in window) ? e.targetTouches[0] : e;

            mx = (e.pageX / window.innerWidth * 2 - 1) * aspect;
            my = e.pageY / window.innerHeight * 2 - 1;

            SQR.VectorUtil.mouseToUnitSphereVector(mx, my, 1.0, currMV);

            var a = Math.min(1, SQR.V3.dot(lastMV, currMV));
            lastMV.cross(currMV, lastMV);
            deltaR.set(a, lastMV.x, lastMV.y, lastMV.z);
            if(isTracked) hairyBall.rotationQ.mul(deltaR);

            lastMV.copyFrom(currMV);
            isTracked = true;
        }
    }

    function onInteractionEnd() {
        isDown = false;
        isTracked = false;
    }

    function render(f) {
        requestAnimFrame(render);
        if(isDown || f) engine.render(camera);
    }

</script>

</head>
<body>
<div id="canvas-container">
    <canvas id="canvas"></canvas>
</div>
<div id="div-container"></div>

<div id="instr">Click/touch and drag on the screen to rotate the globe</div>
</body>
</html>