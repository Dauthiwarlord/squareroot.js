<!DOCTYPE html>
<html>
<head>
    <title>A few bouncing balls | v0.1</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable = no">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <style type="text/css">

        body {
            background-color: #000000;
            overflow: hidden;
        }

        #cnv {
            position: absolute;
            top: 0px;
            left: 0px;
            background-color: #000000;
        }

        #debug {
            position: absolute;
            top: 10px;
            left: 10px;
            font-family: monospace;
            color: #ffffff;
            font-size: 14px;
        }

    </style>

<!-- SQRLIB -->
<!-- Auto-generated by tools/demojstags.py. Do not edit this section -->
<script type="text/javascript" src="../../build/squareroot-min.js"></script>
<!-- SQRLIB -->

    <script type="text/javascript">

        var ctx;

        var gravityDirection = Math.PI * 0.5;
        var gravity = new SQR.V2(
            9.81 * Math.cos(gravityDirection),
            9.81 * Math.sin(gravityDirection)
        );

        var gravityScaled = new SQR.V2();

        var balls = [];
        var numBalls = 20;
        var gravityOn = true;

        var throttle = 0;
        var debugDiv;
        var gx = 0, gy = 0, gz = 0, acc;

        window.onload = function() {

            var cnv = document.getElementById('cnv');
            debugDiv = document.querySelector("#debug");

            ctx = cnv.getContext('2d');

            document.addEventListener('click', function(e) {

                for (var i = 0; i < balls.length; i++) {
                    var b = balls[i];
                    var fx = Math.random() * 1600 - 800;
                    var fy = -800;
                    balls[i].addForce(new SQR.V2(fx * b.mass, fy * b.mass));
                }

            }, false);

            document.addEventListener('touchstart', function(e) {
                e.preventDefault();
            }, false);

            document.addEventListener('touchstart', function(e) {

                for (var i = 0; i < balls.length; i++) {
                    var b = balls[i];
                    var fx = Math.random() * 1600 - 800;
                    var fy = -800;
                    balls[i].addForce(new SQR.V2(fx * b.mass, fy * b.mass));
                }

            }, false);

            document.addEventListener('keydown', function(e) {
                if (e.keyCode == 32) gravityOn = !gravityOn;
            }, false);

            var _tmp = new SQR.V2();

            SQR.Particle.prototype.draw = function(ctx) {

                if (this.position.x + this.radius > window.innerWidth) {
                    this.position.x = window.innerWidth - this.radius;
                    this.velocity.x *= -this.bounciness;
                }

                if (this.position.x - this.radius < 0) {
                    this.position.x = this.radius;
                    this.velocity.x *= -this.bounciness;
                }

                if (this.position.y + this.radius > window.innerHeight) {
                    this.position.y = window.innerHeight - this.radius;
                    this.velocity.y *= -this.bounciness;
                }

                if (this.position.y - this.radius < 0) {
                    this.position.y = this.radius;
                    this.velocity.y *= -this.bounciness;
                }

                for (var i = 0; i < balls.length; i++) {
                    var ob = balls[i];

                    if(ob != this) {
                        _tmp.sub(ob.position, this.position);

                        var coldist = ob.radius + this.radius;
                        coldist = coldist * coldist;

                        var dist = _tmp.magsq();

                        if(dist <= coldist) {
                            var vl = this.velocity.mag();
                            _tmp.copyTo(this.velocity);
                            this.velocity.norm();
                            this.velocity.mul(vl);
                            this.velocity.mul(-this.bounciness);
                        }
                    }
                }


                ctx.strokeStyle = 'rgba(255,0,0, 0.5)';
                ctx.lineWidth = 10;
                ctx.fillStyle = 'rgba(255,0,0, 0.5)';
                ctx.beginPath();
                ctx.arc(this.position.x, this.position.y, this.radius, 0, SQR.twoPI);
                ctx.stroke();
                ctx.fill();
            }

            cnv.width = window.innerWidth;
            cnv.height = window.innerHeight;

            for (var i = 0; i < numBalls; i++) {

                var r = Math.random();

                var b = new SQR.Particle(new SQR.V2(window.innerWidth * Math.random(), 20));

                var rc = Math.min(10, window.innerWidth * 0.02);
                var rv = Math.min(30, window.innerWidth * 0.06);
                b.radius = rc + r * rv;

                b.mass = (1 + r) * 5;
                b.bounciness = 1.0 - r * 0.4;
                b.frictionAir = 1;
                b.frictionGround = 20;
                b.addForce(new SQR.V2(Math.random() * 20 - 10, 0));

                b.position.set(
                    Math.random() * window.innerWidth, 
                    Math.random() * window.innerHeight
                );

                balls.push(b);
            }

            draw();

        }

        window.ondevicemotion = function (e) {
            gx = e.accelerationIncludingGravity.x;
            gy = e.accelerationIncludingGravity.y;
            gz = e.accelerationIncludingGravity.z;

            acc = !(gx == 0 && gy == 0 && gz == 0);
        }

        function draw() {
            requestAnimFrame(draw);

            var isOdd = (++throttle % 2 == 1);

            // debugDiv.innerHTML = gx + "<br>" + gy + "<br>" + gz;
            // debugDiv.innerHTML = gravity.x + " : " + gravity.y;
            //if(isOdd) return;

            ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);
            SQR.Time.tick();

            for (var i = 0; i < balls.length; i++) {

                var b = balls[i];

                b.friction = (b.position >= window.innerHeight - b.radius - 0.1) ? b.frictionAir : b.frictionGround;



                if(acc) gravity.set(gx, -gy);

                if (gravityOn) {
                    gravityScaled.copyFrom(gravity).mul(b.mass);
                    b.addForce(gravityScaled);
                }

                b.update(SQR.Time.deltaTime);
                b.draw(ctx);
            }
        }

    </script>

</head>
<body>
<div id="container">
    <canvas id="cnv"></canvas>
</div>

<div id="debug"></div>
</body>
</html>

















