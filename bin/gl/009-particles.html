<!DOCTYPE html>
<html>
<head>
<title>Hyperspace</title>

<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<style type="text/css">

    body {
        overflow: hidden;
    }

    canvas {
        position: absolute;
        top: 0px;
        left: 0px;
    }

</style>

<script type="text/javascript" src="../../lib/Stats.js"></script>
<script type="text/javascript" src="../../lib/leap2.js"></script>

<!-- SQRLIB -->
<!-- Auto-generated by tools/demojstags.py. Do not edit this section -->
<script type="text/javascript" src="../../src/requestAnimFrame.js"></script>
<script type="text/javascript" src="../../src/SQR.js"></script>
<script type="text/javascript" src="../../src/sqr/Squareroot.js"></script>
<script type="text/javascript" src="../../src/sqr/SquarerootGL.js"></script>
<script type="text/javascript" src="../../src/sqr/Transform.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Cube.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Mesh.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Plane.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Quad.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Sprite2D.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Sprite3D.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Triangle.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Tube.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Interpolation.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Mathx.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Matrix2D.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Matrix33.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Matrix44.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Noise.js"></script>
<script type="text/javascript" src="../../src/sqr/math/PerlinNoise.js"></script>
<script type="text/javascript" src="../../src/sqr/math/ProjectionMatrix.js"></script>
<script type="text/javascript" src="../../src/sqr/math/QuadraticBezier.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Quaternion.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Spline.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Spring.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Vector2.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Vector3.js"></script>
<script type="text/javascript" src="../../src/sqr/math/VectorUtil.js"></script>
<script type="text/javascript" src="../../src/sqr/physics/CSSCollider.js"></script>
<script type="text/javascript" src="../../src/sqr/physics/Particle.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/DOMElement2D.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/DOMElement3D.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/Point.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/Polygon.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/Segment.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/WebGL.js"></script>
<script type="text/javascript" src="../../src/sqr/util/CanvasUtil.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Color.js"></script>
<script type="text/javascript" src="../../src/sqr/util/DOMUtil.js"></script>
<script type="text/javascript" src="../../src/sqr/util/FrameBuffer.js"></script>
<script type="text/javascript" src="../../src/sqr/util/GL.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Interactor.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Loader.js"></script>
<script type="text/javascript" src="../../src/sqr/util/OBJParser.js"></script>
<script type="text/javascript" src="../../src/sqr/util/PostEffect.js"></script>
<script type="text/javascript" src="../../src/sqr/util/RenderRegion.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Shader.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Stringify.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Texture.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Time.js"></script>
<!-- SQRLIB -->
</head>
<body>

<canvas id="gl-canvas"></canvas>

<script type="text/javascript">

    var ParticleCluster = function(size, num) {
        this.vertexSize = 3;
        this.numVertices = num;
        this.dirty = true;

        var that = this;

        var vs = new Float32Array(num * this.vertexSize);
        var ss = new Float32Array(num * this.vertexSize);

        for(var i = 0; i < num * this.vertexSize; i++) {
            vs[i] = Math.random() * size;
            ss[i] = (Math.random() * 2 - 1) * 0.1;
        }

        this.vertices = vs;
        this.aVertexSpeed = ss;
    };

    var createCluster = function() {
        var shader = engine.createShader();
        shader.load("glsl/particles-basic.glsl");

        var size = 500;
        var num = 25000;
        var cluster = new SQR.Transform();
        cluster.geometry = new ParticleCluster(size, num);
        cluster.renderer = engine.createRenderer(shader);
        cluster.renderer.transparent = true;
        cluster.renderer.u.uColor = [1, 1, 1, 1];
        cluster.renderer.u.uOffset = new SQR.V3();
        cluster.renderer.u.uSize = size;
        cluster.renderer.renderMode = SQR.GL.POINTS;
        root.add(cluster);
        return cluster;
    }

    var createRings = function() {
        var numRings = 20;
        var rings = [];

        var ringRenderer = engine.createRenderer(normal2color);

        for(var i = 0; i < numRings; i++) {

            var ring = new SQR.Transform();


            var twistRing = function(m, r) {
                m.rotate(0, Math.cos(r * 3), 0);
            }

            var ringGeo = new SQR.Tube()
            .resolution(60)
            .outer(20 + i)
            .inner(10 + i)
            .height(2 + i)
            .smooth(false)
            .setTwist(twistRing)
            .refresh();

            
            ring.geometry = ringGeo;
            ring.renderer = ringRenderer;
            ring.renderer.u.uColor = [1, 0, 0, 1];
        
            var p = new SQR.V3().random().norm().mul(Math.random() * 600 + 200);
            ring.position.copyFrom(p);

            // var r = new SQR.V3().random().norm();
            // var a = Math.random() * SQR.twoPI;
            // ring.rotationQ.fromAngleAxis(a, r.x, r.y, r.z);
            // ring.useQuaternion = true;
            
            root.add(ring);
            rings.push(ring);
        }

        return rings;
    }

    var createLogos = function() {
        var logo = new SQR.Transform();
        logo.geometry = new SQR.Mesh("assets/tool-logo-blend.obj");
        logo.renderer = engine.createRenderer(normal2color);
        logo.renderer.u.uColor = [0, 0.5, 0, 1];
        logo.scale.set(0.2, 0.2, 0.2);
        root.add(logo);

        var p = new SQR.V3().random().norm().mul(Math.random() * 600 + 200);
        logo.position.copyFrom(p);

        // var r = new SQR.V3().random().norm();
        // var a = Math.random() * SQR.twoPI;
        // logo.rotationQ.fromAngleAxis(a, r.x, r.y, r.z);
        // logo.useQuaternion = true;
    }

    var stats = new Stats();
    stats.domElement.style.position = 'absolute';
    stats.domElement.style.left = '0px';
    stats.domElement.style.top = '0px';
    document.body.appendChild( stats.domElement );

    var engine = new SQR.SquarerootGL(document.getElementById('gl-canvas'));
    engine.setSize(window.innerWidth, window.innerHeight);
    engine.setClearColor(0, 0, 0, 1);

    var projection = new SQR.ProjectionMatrix();
    projection.perspective(45, window.innerWidth/window.innerHeight, 1, 10000);
    engine.setProjection(projection);

    


    var normal2color = engine.createShader();
    normal2color.load("glsl/normal2colorFog.glsl");

    var root = new SQR.Transform();

    var camera = new SQR.Transform();
    camera.useQuaternion = true;
    root.add(camera);

    var eye = new SQR.Transform();
    camera.add(eye);

    var cluster = createCluster();
    var rings = createRings();
    // createLogos();

    var lt = 0;

    var mover = {
        axis: new SQR.V3(), 
        rotation: new SQR.Quaternion(),
        rotX: 0, 
        rotY: 0, 
        rotZ: 0,
        speed: 0,
        speedTarget: 0
    }

    var leapLoop = function(frame) {
        if(frame.hands.length > 0) {
            var hand = frame.hands[0];
            var pos = hand.palmPosition;

            mover.rotX = -hand.roll();
            /// mover.rotY = (pos[1] - 200) / -200;
            mover.rotY = -hand.pitch();
            /// mover.rotZ = -hand.pitch();
            mover.speedTarget = (pos[2] - 50);// * frame.fingers.length;
        } else {
            mover.rotX *=  0.95; 
            mover.rotY *=  0.95;
            mover.rotZ *=  0.95;
            mover.speedTarget = 0;
        }
    };

    Leap.loop(leapLoop);

    var appendRotation = function(camera, axis, angle) {
        mover.axis.copyFrom(axis);
        mover.rotation.fromAngleAxis(angle, mover.axis.x, mover.axis.y, mover.axis.z);
        mover.rotation.mul(camera.rotationQ);
        camera.rotationQ.copyFrom(mover.rotation);
    }

    function render(t) {
        var dt = (t - lt);
        lt = t;
        stats.begin();
        requestAnimFrame(render);

        if(!dt || isNaN(dt)) dt = 0;
        var dts = dt * 0.001;

        mover.speed += (mover.speedTarget - mover.speed) * 0.1;

        cluster.renderer.u.uTime = t / 100;

        appendRotation(camera, camera.top, mover.rotX * -0.02);
        appendRotation(camera, camera.left, mover.rotY * -0.02);
        appendRotation(camera, camera.forward, mover.rotX * -0.02);

        mover.axis.copyFrom(camera.forward);
        camera.position.appendVec(mover.axis.norm().mul(dts * mover.speed));

        cluster.position.copyFrom(camera.position);
        cluster.renderer.u.uOffset.copyFrom(camera.position);

        for(var i = 0; i < rings.length; i++) {
            rings[i].rotation.x += 0.2 * dts;
            rings[i].rotation.y += 0.1 * dts;
        }

        engine.render(root, eye);
        stats.end();
    }

    render();

</script>

<script>document.write('<script src="http://' + (location.host || 'localhost').split(':')[0] + ':35729/livereload.js?snipver=1"></' + 'script>')</script>

</body>
</head>




















