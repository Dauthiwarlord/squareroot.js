<!DOCTYPE html>
<html>
<head>
<title>GL Terrain | v0.10</title>

<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<style type="text/css">

    body {
        overflow: hidden;
    }

    canvas {
        position: absolute;
        top: 0px;
        left: 0px;
    }

</style>

<script type="text/javascript" src="../../lib/Stats.js"></script>

<!-- SQRLIB -->
<!-- Auto-generated by tools/demojstags.py. Do not edit this section -->
<script type="text/javascript" src="../../src/requestAnimFrame.js"></script>
<script type="text/javascript" src="../../src/SQR.js"></script>
<script type="text/javascript" src="../../src/sqr/Squareroot.js"></script>
<script type="text/javascript" src="../../src/sqr/SquarerootGL.js"></script>
<script type="text/javascript" src="../../src/sqr/Transform.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Cube.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Cylinder.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Geometry.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Icosphere.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Mesh.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Plane.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Pyramid.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Quad.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Sprite2D.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Sprite3D.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Triangle.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Tube.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Interpolation.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Mathx.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Matrix2D.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Matrix33.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Matrix44.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Noise.js"></script>
<script type="text/javascript" src="../../src/sqr/math/PerlinNoise.js"></script>
<script type="text/javascript" src="../../src/sqr/math/ProjectionMatrix.js"></script>
<script type="text/javascript" src="../../src/sqr/math/QuadraticBezier.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Quaternion.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Spline.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Spring.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Vector2.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Vector3.js"></script>
<script type="text/javascript" src="../../src/sqr/math/VectorUtil.js"></script>
<script type="text/javascript" src="../../src/sqr/physics/CSSCollider.js"></script>
<script type="text/javascript" src="../../src/sqr/physics/Particle.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/DOMElement2D.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/DOMElement3D.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/Point.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/Polygon.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/Segment.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/WebGL.js"></script>
<script type="text/javascript" src="../../src/sqr/util/CanvasUtil.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Color.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Cubemap.js"></script>
<script type="text/javascript" src="../../src/sqr/util/DOMUtil.js"></script>
<script type="text/javascript" src="../../src/sqr/util/FrameBuffer.js"></script>
<script type="text/javascript" src="../../src/sqr/util/GL.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Interactor.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Loader.js"></script>
<script type="text/javascript" src="../../src/sqr/util/OBJParser.js"></script>
<script type="text/javascript" src="../../src/sqr/util/PostEffect.js"></script>
<script type="text/javascript" src="../../src/sqr/util/RenderRegion.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Shader.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Stringify.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Texture.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Time.js"></script>
<!-- SQRLIB -->
</head>
<body>

<canvas id="gl-canvas"></canvas>

<script type="text/javascript">

    var applyHeightMap = function(geo, heightMap, maxHeight, offsetX, offsetY, rangeX, rangeY) {

        
    }

    var stats = new Stats();
    stats.domElement.style.position = 'absolute';
    stats.domElement.style.left = '0px';
    stats.domElement.style.top = '0px';
    // document.body.appendChild( stats.domElement );

    var engine, root, camera, birdview, terrain, terrainRenderer;
    var size = 400;
    var density = 127;

    engine = new SQR.SquarerootGL(document.getElementById('gl-canvas'));
    engine.setSize(window.innerWidth, window.innerHeight);
    engine.setClearColor(20/255, 96/255, 132/255, 1);

    var projection = new SQR.ProjectionMatrix();
    projection.perspective(45, window.innerWidth/window.innerHeight, 1, 10000);
    engine.setProjection(projection);

    var setup = function(dta) {
        var shader = engine.createShader();
        shader.load("glsl/terrain.glsl");

        terrain = new SQR.Transform(); 

        var geo = new SQR.Plane({ quads:true, vertexNormals:false }).create(size, size, density, density);

        geo.displaceVertices(function(v) {
            var x = Math.round(v.x/geo.width * 128 + 64);
            var z = Math.round(v.z/geo.height * 128 + 64);

            if(x ==  128) x = 0;
            if(z == 128) z = 0;

            var th = SQR.CanvasUtil.getPixelRed(dta, x, z) / 255;
            th = Math.max(0.2 , th);
            v.y = th * 15;
        });

      
        terrainRenderer = engine.createRenderer(shader);
        terrainRenderer.u.uColor = [217/255, 167/255, 108/255, 1];
        terrainRenderer.u.near = 1;
        terrainRenderer.u.far = 50;
        terrainRenderer.u.uFogColor = [20/255, 96/255, 132/255];

        var addPlane = function(x, z) {
            var p = new SQR.Transform();
            p.geometry = geo;
            p.renderer = terrainRenderer;
            p.position.set(x, 0, z);
            terrain.add(p);
        } 


        addPlane(0, 0);
        addPlane(0, -size);

        addPlane(size, 0);
        addPlane(size, -size);

        root = new SQR.Transform();
        root.add(terrain);
        
        camera = new SQR.Transform();
        camera.position.y = 15;
        camera.useQuaternion = true;

        root.add(camera);

        birdview = new SQR.Transform();
        birdview.position.z = 200;
        birdview.position.y = 500;
        birdview.lookAt(camera);

        camera.add(birdview);
    }

    var lt = 0;
    var phase = 0;

    var bridViewActive = false;

    var speed = 0, targetSpeed = 0, targetRotation = 0, targetBank = 0, rotationAcc = 0;

    document.addEventListener('keydown', function(e) {
        if(e.keyCode == 32) bridViewActive = !bridViewActive;

        if(e.keyCode == 40) targetSpeed += 0.1;
        if(e.keyCode == 38) targetSpeed -= 0.1;

        var q = new SQR.Quaternion();

        if(e.keyCode == 37) {
            rotationAcc = -0.02;
            targetBank = -0.5;
        }

        if(e.keyCode == 39) {
            rotationAcc = 0.02;
            targetBank = 0.5;
        }
    });

    document.addEventListener('keyup', function(e) {
        rotationAcc = 0;
        targetBank = 0;
    });

    var q = new SQR.Quaternion();


    // //
    var depth = engine.createShader();
    depth.load("glsl/depth.glsl", render);
    depth.u.far = 100;
    depth.u.near = 40;

    var target = engine.createFrameBuffer();

    var blurTargetA1 = engine.createFrameBuffer();
    var blurTargetA2 = engine.createFrameBuffer();

    var depthTarget = engine.createFrameBuffer();
    var depthBlurTarget = engine.createFrameBuffer();

    var invert = new SQR.PostEffect("glsl/simpleFx.glsl");
    var blur = new SQR.PostEffect("glsl/blur.glsl");
    var preview = new SQR.PostEffect("glsl/passThru.glsl");

    var depthField = new SQR.PostEffect("glsl/depthOfField.glsl");
    depthField.renderer.u.uBlurTexture = blurTargetA2.texture;
    depthField.renderer.u.uDepthTexture = depthTarget.texture;

    var previewRegionSmall = new SQR.RenderRegion(50, 50, window.innerWidth/5, window.innerHeight/5);
    // //


    var render = function(t) {
        var dt = (t - lt);
        lt = t;
        stats.begin();
        requestAnimFrame(render);

        if(!dt || isNaN(dt)) dt = 0;
        var dts = dt * 0.001;

        targetRotation += rotationAcc;
        speed += (targetSpeed - speed) * 0.2;

        camera.rotation.z += (targetBank - camera.rotation.z) * 0.1;
        camera.rotation.y += (targetRotation - camera.rotation.y) * 0.1;

        camera.rotationQ.set();

        q.fromAngleAxis(camera.rotation.z, 0, 0, 1);
        camera.rotationQ.mul(q);

        q.fromAngleAxis(camera.rotation.y, 0, 1, 0);
        camera.rotationQ.mul(q);

        camera.forward.mul(speed);
        camera.position.appendVec(camera.forward);


        for(var i = 0; i < terrain.numChildren; i++) {
            var t = terrain.children[i];
            var dx = camera.position.x - t.globalPosition().x;
            var dz = camera.position.z - t.globalPosition().z;

            if(dx < -size) t.position.x -= size * 2;
            if(dx > size) t.position.x += size * 2;

            if(dz < -size) t.position.z -= size * 2;
            if(dz > size) t.position.z += size * 2;
        }

        terrainRenderer.u.far = (bridViewActive) ? 1000 : 200;

        // engine.render(root, camera);

        engine.render(root, camera, { target: target });
        preview.setSource(target);
        blur.renderer.u.delta = [0, 0.05];
        blur.setSource(target);
        engine.render(blur, null, { target: blurTargetA1 });
        blur.setSource(blurTargetA1);
        blur.renderer.u.delta = [0.05, 0];
        engine.render(blur, null, { target: blurTargetA2 });
        engine.render(root, camera, { target:depthTarget, replacementShader: depth, clearColor:[0,0,0,1] });
        preview.setSource(depthTarget);
        depthField.setSource(target);
        engine.render(depthField);

        stats.end();
    }

    var loadMap = function(callback) {
            var hmc = document.createElement('canvas');
            hctx = hmc.getContext('2d');

            var hmimage = new Image();
            hmimage.onload = function() {

                hmc.width = hmimage.width;
                hmc.height = hmimage.height;

                hctx.drawImage(hmimage, 0, 0);
                hdata = hctx.getImageData(0, 0, hmc.width, hmc.height);

                if(callback) callback(hdata);
            }

            hmimage.src = 'assets/heightmap2.jpg';
    }

    loadMap(function(dta) {
        setup(dta);
        render();
        // setTimeout(render, 1000);
    });


    


</script>

<script>document.write('<script src="http://' + (location.host || 'localhost').split(':')[0] + ':35729/livereload.js?snipver=1"></' + 'script>')</script>

</body>
</head>




















