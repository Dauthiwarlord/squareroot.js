<!DOCTYPE html>
<html>
<head>
    <title>Terrain | v0.10</title>

    <script type="text/javascript" src="../../lib/requestAnimFrame.js"></script>

    <script type="text/javascript" src="../../src/SQR.js"></script>

    <script type="text/javascript" src="../../src/engine/Engine.js"></script>
    <script type="text/javascript" src="../../src/engine/Transform.js"></script>
    <script type="text/javascript" src="../../src/engine/Geometry.js"></script>
    <script type="text/javascript" src="../../src/engine/objects/Triangle.js"></script>
    <script type="text/javascript" src="../../src/engine/objects/Plane.js"></script>
    <script type="text/javascript" src="../../src/engine/renderers/DOMElement.js"></script>
    <script type="text/javascript" src="../../src/engine/renderers/Particle.js"></script>
    <script type="text/javascript" src="../../src/engine/renderers/Segment.js"></script>
    <script type="text/javascript" src="../../src/engine/renderers/Polygon.js"></script>

    <script type="text/javascript" src="../../src/math/Vector2.js"></script>
    <script type="text/javascript" src="../../src/math/Vector3.js"></script>
    <script type="text/javascript" src="../../src/math/ProjectionMatrix.js"></script>
    <script type="text/javascript" src="../../src/math/Matrix44.js"></script>

    <script type="text/javascript" src="../../src/engine/util/Stringify.js"></script>
    <script type="text/javascript" src="../../src/engine/util/DOMUtil.js"></script>
    <script type="text/javascript" src="../../src/engine/util/Time.js"></script>
    <script type="text/javascript" src="../../src/engine/util/Color.js"></script>
    <script type="text/javascript" src="../../src/engine/util/CanvasUtil.js"></script>

    <style type="text/css">

        body {
            overflow: hidden;
        }

        #canvas {
            position: absolute;
            top: 0px;
            left: 0px;
        }

        #hm-container {
            position: absolute;
            top: 0px;
            left: 0px;
        }

    </style>

    <script type="text/javascript">

        var engine, camera, geometry, renderer, terrain;
        var hmc, hctx, hdata;
        var zero = new SQR.V3();
        var mx = 0, my = 0;

        window.onload = function() {

            document.addEventListener('touchmove', function(e) {
                e.preventDefault();
            }, false);

            document.addEventListener('mousemove', function(e) {
                mx = e.pageX / window.innerWidth;
            }, false);

            engine = new SQR.Engine(document.getElementById('canvas'), document.getElementById("div-container"));
            engine.setBackground("#000000");
            engine.setSize(window.innerWidth, window.innerHeight);
            engine.setProjection(45);

            camera = new SQR.Transform();
            camera.position.z = 140;
            camera.position.y = 140;

            terrain = new SQR.Transform();
            terrain.renderer = new SQR.Polygon();
            terrain.geometry = new SQR.Plane(100, 100, 20, 20, 0, 0, true);
            //terrain.scale.set(100, 100, 100);

            engine.add(camera, terrain);
            camera.lookInDirection(terrain.position);

            hmc = document.createElement('canvas');
            document.getElementById('hm-container').appendChild(hmc);
            hctx = hmc.getContext('2d');

            var hmimage = new Image();
            hmimage.onload = function() {
                
                hmc.width = hmimage.width;
                hmc.height = hmimage.height;

                hctx.drawImage(hmimage, 0, 0);
                hdata = hctx.getImageData(0, 0, hmc.width, hmc.height);

                terrain.geometry.applyHeightMap(hdata, 0.2, 0.5);

                render();
            }

            hmimage.src = 'assets/terrain-heightmap.jpg';
        }

        function v(x, y, z) {
            return new SQR.V3(x, y, z);
        }

        var th = 0;
        var a = 0;

        function render() {
            requestAnimFrame(render);
            //if(th++ % 2 == 1) return;

            terrain.rotation.y += 0.002;

            //terrain.geometry.applyHeightMap(hdata, 0.4, a);
            a += 0.1;
            if (a > hmc.height - 11) a = 0;


            engine.render(camera);
        }

    </script>

</head>
<body>
<div id="canvas-container">
    <canvas id="canvas"></canvas>
</div>
<div id="div-container"></div>

<div id="hm-container"></div>
</body>
</html>