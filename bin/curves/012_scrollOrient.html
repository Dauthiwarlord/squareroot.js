<!DOCTYPE html>
<html>
<head>
<title>012 Scroll along a spline | v0.1</title>

<link rel="stylesheet" href="curves.css">

<style type="text/css">

    body {
        color: #000000;
    }

    #desc {
        position: absolute;
    }

    #images {
        display: none;
    }

    canvas {
        background: #ffffff;
        position: absolute;
        top: 0px;
        left: 0px;
    }
</style>

<script type="text/javascript" src="../../lib/requestAnimFrame.js"></script>

<!-- SQRLIB -->
<!-- Auto-generated by tools/demojstags.py. Do not edit this section -->
<script type="text/javascript" src="../../lib/requestAnimFrame.js"></script>
<script type="text/javascript" src="../../src/SQR.js"></script>
<script type="text/javascript" src="../../src/color/Color.js"></script>
<script type="text/javascript" src="../../src/math/Interpolation.js"></script>
<script type="text/javascript" src="../../src/math/Mathx.js"></script>
<script type="text/javascript" src="../../src/math/Matrix2D.js"></script>
<script type="text/javascript" src="../../src/math/Matrix33.js"></script>
<script type="text/javascript" src="../../src/math/Matrix44.js"></script>
<script type="text/javascript" src="../../src/math/Noise.js"></script>
<script type="text/javascript" src="../../src/math/PerlinNoise.js"></script>
<script type="text/javascript" src="../../src/math/ProjectionMatrix.js"></script>
<script type="text/javascript" src="../../src/math/QuadraticBezier.js"></script>
<script type="text/javascript" src="../../src/math/Quaternion.js"></script>
<script type="text/javascript" src="../../src/math/Spline.js"></script>
<script type="text/javascript" src="../../src/math/Spring.js"></script>
<script type="text/javascript" src="../../src/math/Vector2.js"></script>
<script type="text/javascript" src="../../src/math/Vector3.js"></script>
<script type="text/javascript" src="../../src/math/VectorUtil.js"></script>
<script type="text/javascript" src="../../src/sqr/Geometry.js"></script>
<script type="text/javascript" src="../../src/sqr/Squareroot.js"></script>
<script type="text/javascript" src="../../src/sqr/Transform.js"></script>
<script type="text/javascript" src="../../src/sqr/objects/Particle2D.js"></script>
<script type="text/javascript" src="../../src/sqr/objects/Plane.js"></script>
<script type="text/javascript" src="../../src/sqr/objects/Quad.js"></script>
<script type="text/javascript" src="../../src/sqr/objects/Triangle.js"></script>
<script type="text/javascript" src="../../src/sqr/physics/CSSCollider.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/DOMElement2D.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/DOMElement3D.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/Particle.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/Polygon.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/Segment.js"></script>
<script type="text/javascript" src="../../src/sqr/util/CanvasUtil.js"></script>
<script type="text/javascript" src="../../src/sqr/util/DOMUtil.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Interactor.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Stringify.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Time.js"></script>
<!-- SQRLIB -->

<script type="text/javascript">

    var ctx, sp;
    var p = new SQR.V2();
    var v = new SQR.V2();
    var vn = new SQR.V2();

    var squareSize = 200;
    var squareOutlineSize = squareSize + 5;

    var cnWidth = window.innerWidth;
    var cnHeight = window.innerHeight;

    var centerX = cnWidth * 0.5;
    var centerY = cnHeight * 0.5;

    var numSquares = 15;
    var numAddons = 100;

    var scrollPos = 0;
    var scrollTarget = 0;

    var colors, addonOffsets;

    var image1, image2;

    function drawControlPoints(s) {
        ctx.globalAlpha = 0.2;
        ctx.strokeStyle = 'rgb(255,0,0)';

        ctx.beginPath();

        for (var i = 0; i < s.controlPoints.length; i++) {
            var p = s.controlPoints[i];
            if (i == 0) ctx.moveTo(p.x, p.y);
            else ctx.lineTo(p.x, p.y);
        }

        ctx.stroke();
    }

    function drawSpline(s) {
        ctx.globalAlpha = 0.2;
        ctx.strokeStyle = 'rgb(0,0,128)';

        ctx.beginPath();

        for (var i = 0; i <= 100; i++) {
            var t = i / 100;
            var cv = s.valueAt(t);
            if (i == 0) ctx.moveTo(cv.x, cv.y);
            else ctx.lineTo(cv.x, cv.y);
        }

        ctx.stroke();
    }

    function drawSquaresOnSpline(s, freq, tx, ty, go, gt) {
        ctx.globalAlpha = 1;


        for (var i = 0; i <= freq; i++) {
            var t = i / freq;

            p = s.valueAt(t);
            v = s.velocityAt(t, v).norm();

            var dist = (1 - Math.abs(t - gt) * 6);
            var orientation = Math.atan2(v.y, v.x);

            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.fillStyle = colors[i];

            ctx.translate(centerX, centerY);
            ctx.rotate(go);
            ctx.translate(tx, ty);

            ctx.translate(p.x, p.y);
            ctx.rotate(orientation + Math.PI * -0.5);

            var sq = squareSize * dist;

            var img = (i % 2 == 0) ? image1 : image2;

            ctx.drawImage(img, -sq, -sq, sq * 2, sq * 2);

            ctx.globalAlpha = 0.3;

            ctx.beginPath();
            ctx.moveTo(-sq, sq);
            ctx.lineTo(sq, sq);
            ctx.lineTo(sq, -sq);
            ctx.lineTo(-sq, -sq);
            ctx.fill();

            ctx.globalAlpha = 1;
        }
    }

    function drawAddonsOnSpline(s, freq, tx, ty, go, gt) {
        ctx.globalAlpha = 1;


        for (var i = 0; i <= freq; i++) {
            var t = i / freq;

            p = s.valueAt(t);
            v = s.velocityAt(t, v).norm();

            v.mul(addonOffsets[i]).perpendicular();
            vn.copyFrom(v);

            if (i % 2 == 0) vn.neg();

            var dist = 1 - (Math.abs(t - gt) * 4);
            var orientation = Math.atan2(v.y, v.x);

            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.fillStyle = colors[i];

            ctx.translate(centerX, centerY);
            ctx.rotate(go);
            ctx.translate(tx, ty);

            ctx.translate(p.x + vn.x, p.y + vn.y);
            ctx.rotate(orientation);

            var sq = squareSize / 5 * dist;

            ctx.beginPath();
            ctx.moveTo(-sq, sq);
            ctx.lineTo(sq, sq);
            ctx.lineTo(sq, -sq);
            ctx.lineTo(-sq, -sq);
            ctx.fill();
        }
    }

    window.onload = function() {

        image1 = document.getElementById('img1');
        image2 = document.getElementById('img2');

        document.addEventListener('mousewheel', function(e) {
            scrollTarget += e.wheelDeltaY / window.innerHeight * -0.03;

            scrollTarget = Math.max(0, scrollTarget);
            scrollTarget = Math.min(1, scrollTarget);

        }, false);

        var cnv = document.getElementById('cnv');
        cnv.width = cnWidth;
        cnv.height = cnHeight;

        ctx = cnv.getContext('2d');

        colors = [];
        addonOffsets = [];

        for (var i = 0; i < numAddons; i++) {
            var c = 'hsl(' + (Math.random() * 255 | 0) + ',70%,50%)';
            colors.push(c);
            var ao = 200 + Math.random() * 300;
            if (Math.random() > 0.5) ao *= -1;
            addonOffsets.push(ao);
        }

        var scale = 1300;

        sp = new SQR.Spline(
                new SQR.V2(0, 0),
                new SQR.V2(0, scale),
                new SQR.V2(-scale, scale * 2),
                new SQR.V2(-scale * 2, -scale)
        );

        sp.add(
                new SQR.V2(-scale * 3, 0),
                new SQR.V2(-scale * 4, scale)
        );

        sp.add(
                new SQR.V2(-scale * 5, scale),
                new SQR.V2(-scale * 5, 0)
        );

        draw();
    }

    function draw() {
        requestAnimFrame(draw);

        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.clearRect(0, 0, cnWidth, cnHeight);

        scrollPos += (scrollTarget - scrollPos) / 20;

        var t = scrollPos;

        p = sp.valueAt(t);
        v = sp.velocityAt(t, v).norm();

        var orientation = -Math.atan2(v.y, v.x) + Math.PI / 2;

        var ofx = -p.x;
        var ofy = -p.y;

        ctx.translate(centerX, centerY);
        ctx.rotate(orientation);
        ctx.translate(ofx, ofy);

        drawAddonsOnSpline(sp, numAddons, ofx, ofy, orientation, t);
        drawSquaresOnSpline(sp, numSquares, ofx, ofy, orientation, t);
    }

</script>

</head>
<body>

<div id="images">
    <img src="../assets/fruits-400.jpg" id="img1">
    <img src="../assets/square-400.jpg" id="img2">
</div>

<div id="container">
    <canvas id="cnv"></canvas>
</div>

<div id="desc">
    <h1>012 Scroll along a spline</h1>

    <p>A expmeriment in using mouse scroll to move things along a spline<br>(with a bit of orient to path)</p>
</div>

</body>
</html>