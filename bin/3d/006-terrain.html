<!DOCTYPE html>
<html>
<head>
    <title>Terrain | v0.30</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable = no">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <script type="text/javascript" src="../../lib/Stats.js"></script>

<!-- SQRLIB -->
<!-- Auto-generated by tools/demojstags.py. Do not edit this section -->
<script type="text/javascript" src="../../build/squareroot-min.js"></script>
<!-- SQRLIB -->

    <style type="text/css">

        body {
            overflow: hidden;
        }

        #canvas {
            position: absolute;
            top: 0px;
            left: 0px;
            background-color: #000;
        }

        #hm-container {
            position: absolute;
            top: 0px;
            left: 0px;
        }

    </style>

    <script type="text/javascript">

        var engine, camera, geometry, renderer, terrain;
        var hmc, hctx, hdata;
        var zero = new SQR.V3();
        var mx = 0, my = 0;
        var stats;

        SQR.Plane.prototype.applyHeightMap = function(heightMap, maxHeight, offset, range) {

            var numTriangles = this.faces.length;

            var w = this.width * 0.5;
            var h = this.height * 0.5;
     
            var processVertex = function(t, ut) {
                var row = (t.z / h + 1) / 2;
                var col = (t.x / w + 1) / 2;

                row = (offset + row * range) % 1;

                var hl = SQR.CanvasUtil.getPixelNormRed(heightMap, col, row) / 255;
                t.y = maxHeight * (1-hl) - maxHeight * 0.5;
            }

            for (var i = 0; i < numTriangles; i++) {
                var t = this.faces[i];
                var vs = t.vertices;
                processVertex(vs[0], t.uva);
                processVertex(vs[1], t.uvc);
                processVertex(vs[2], t.uvb);
                if(vs[3]) processVertex(vs[3], t.uvd);
            }
        }

        window.onload = function() {
            
           stats = new Stats();
           stats.setMode(0);
           stats.domElement.style.position = 'absolute';
           stats.domElement.style.left = '0px';
           stats.domElement.style.top = '0px';
           document.body.appendChild(stats.domElement);

            document.addEventListener('touchmove', function(e) {
                e.preventDefault();
            }, false);

            document.addEventListener('mousemove', function(e) {
                mx = e.pageX / window.innerWidth;
            }, false);

            engine = new SQR.Squareroot(document.getElementById('canvas'), document.getElementById("div-container"));
            engine.setSize(window.innerWidth, window.innerHeight);
            engine.setProjection(45);
            engine.setBackground("rgba(0,0,0,1)");
            engine.lightDirection.set(1, -0.5, 0).norm();

            terrain = new SQR.Transform();

            terrain.renderer = new SQR.Polygon(new SQR.Color(0, 100, 50));

            terrain.renderer.useLight = true;
            terrain.renderer.wireframe = false;
            terrain.renderer.lightIntensity = function(l) {
                return SQR.Interpolation.smoothStep(-3.0, 1.0, l);
            }

            terrain.geometry = new SQR.Plane({ quads: true }).setSize(120, 120, 20, 20);

            camera = new SQR.Transform();
            camera.position.z = 140;
            camera.position.y = 150;
            camera.rotation.x = -0.9;

            engine.add(camera, terrain);

            hmc = document.createElement('canvas');
//            document.getElementById('hm-container').appendChild(hmc);
            hctx = hmc.getContext('2d');

            var hmimage = new Image();
            hmimage.onload = function() {

                hmc.width = hmimage.width;
                hmc.height = hmimage.height;

                hctx.drawImage(hmimage, 0, 0);
                hdata = hctx.getImageData(0, 0, hmc.width, hmc.height);

                render();
            }

            hmimage.src = '../assets/terrain-heightmap.jpg';
        }

        function v(x, y, z) {
            return new SQR.V3(x, y, z);
        }

        var th = 0;
        var a = 0;
        var fc = 0;

        function render() {
            stats.begin();

            // if(fc++ < 100) 
                requestAnimFrame(render);
            
            if(th++ % 2 == 1) {
                //stats.end();
                //return;
            };

            // terrain.rotation.y += 0.001;
            terrain.rotation.y = Math.PI / 4;

            terrain.geometry.applyHeightMap(hdata, 40, a, 0.1);
            a += 0.03 * SQR.Time.deltaTime;

            engine.render(camera);

            stats.end();
        }

    </script>

</head>
<body>
<div id="canvas-container">
    <canvas id="canvas"></canvas>
</div>
<div id="div-container"></div>

<div id="hm-container"></div>

<script>document.write('<script src="http://' + (location.host || 'localhost').split(':')[0] + ':35729/livereload.js?snipver=1"></' + 'script>')</script>

</body>
</html>