<!DOCTYPE html>
<html>
<head>
    <title>Terrain | v0.30</title>

    <script type="text/javascript" src="../../lib/Stats.js"></script>
    <script type="text/javascript" src="../../lib/requestAnimFrame.js"></script>

<!-- SQRLIB -->
<!-- Auto-generated by tools/demojstags.py. Do not edit this section -->
<script type="text/javascript" src="../../build/squareroot-min.js"></script>
<!-- SQRLIB -->

    <style type="text/css">

        body {
            overflow: hidden;
        }

        #canvas {
            position: absolute;
            top: 0px;
            left: 0px;
        }

        #hm-container {
            position: absolute;
            top: 0px;
            left: 0px;
        }

    </style>

    <script type="text/javascript">

        var engine, camera, geometry, renderer, terrain;
        var hmc, hctx, hdata;
        var zero = new SQR.V3();
        var mx = 0, my = 0;
        var stats;

        window.onload = function() {

//            stats = new Stats();
//            stats.setMode(0);
//            stats.domElement.style.position = 'absolute';
//            stats.domElement.style.left = '0px';
//            stats.domElement.style.top = '0px';
//            document.body.appendChild(stats.domElement);

            document.addEventListener('touchmove', function(e) {
                e.preventDefault();
            }, false);

            document.addEventListener('mousemove', function(e) {
                mx = e.pageX / window.innerWidth;
            }, false);

            engine = new SQR.Squareroot(document.getElementById('canvas'), document.getElementById("div-container"));
            engine.setBackground("#000000");
            engine.setSize(window.innerWidth, window.innerHeight);
            engine.setProjection(45);
            engine.setClearColor("rgba(0,0,0,0.2)");

            terrain = new SQR.Transform();

            terrain.renderer = new SQR.Polygon();
            terrain.renderer.useLight = true;

            terrain.geometry = new SQR.Plane(100, 100, 16, 16, 0, 0, true);

            camera = new SQR.Transform();
            camera.position.z = 140;
            camera.position.y = -140;

            camera.rotation.x = 0.9;
//            camera.lookInDirection(terrain.position);

            engine.add(camera, terrain);

            hmc = document.createElement('canvas');
//            document.getElementById('hm-container').appendChild(hmc);
            hctx = hmc.getContext('2d');

            var hmimage = new Image();
            hmimage.onload = function() {

                hmc.width = hmimage.width;
                hmc.height = hmimage.height;

                hctx.drawImage(hmimage, 0, 0);
                hdata = hctx.getImageData(0, 0, hmc.width, hmc.height);

                render();
            }

            hmimage.src = '../assets/terrain-heightmap.jpg';
        }

        function v(x, y, z) {
            return new SQR.V3(x, y, z);
        }

        var th = 0;
        var a = 0;

        function render() {
            //stats.begin();

            requestAnimFrame(render);
            
            if(th++ % 2 == 1) {
                //stats.end();
                //return;
            };

            terrain.rotation.y += 0.002;

            terrain.geometry.applyHeightMap(hdata, 40, a, 0.1);
            a += 0.02 * SQR.Time.deltaTime;

            engine.render(camera);

            //stats.end();
        }

    </script>

</head>
<body>
<div id="canvas-container">
    <canvas id="canvas"></canvas>
</div>
<div id="div-container"></div>

<div id="hm-container"></div>
</body>
</html>